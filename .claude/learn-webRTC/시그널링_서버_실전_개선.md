# ì‹œê·¸ë„ë§ ì„œë²„ ì‹¤ì „ ê°œì„  ê°€ì´ë“œ

> ì‘ì„±ì¼: 2025-12-31
> ëŒ€ìƒ: ì£¼ë‹ˆì–´ ê°œë°œì (Node.js + Socket.io ê¸°ì´ˆ ì™„ë£Œ)
> ëª©ì : ë°ëª¨ ì½”ë“œë¥¼ ì‹¤ì „ í”„ë¡œë•ì…˜ ìˆ˜ì¤€ìœ¼ë¡œ ê°œì„ í•˜ê¸°

---

## ëª©ì°¨

1. [í˜„ì¬ ì½”ë“œì˜ í•œê³„ì ](#1-í˜„ì¬-ì½”ë“œì˜-í•œê³„ì )
2. [ì¸ì¦ ì‹œìŠ¤í…œ (JWT)](#2-ì¸ì¦-ì‹œìŠ¤í…œ-jwt)
3. [ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™](#3-ë°ì´í„°ë² ì´ìŠ¤-ì—°ë™)
4. [Rate Limiting](#4-rate-limiting)
5. [ë°© ìµœëŒ€ ì¸ì› ì œí•œ](#5-ë°©-ìµœëŒ€-ì¸ì›-ì œí•œ)
6. [Redis ë‹¤ì¤‘ ì„œë²„ í™•ì¥](#6-redis-ë‹¤ì¤‘-ì„œë²„-í™•ì¥)
7. [ë¡œê¹… ì‹œìŠ¤í…œ](#7-ë¡œê¹…-ì‹œìŠ¤í…œ)
8. [ì—ëŸ¬ ì²˜ë¦¬ ê³ ë„í™”](#8-ì—ëŸ¬-ì²˜ë¦¬-ê³ ë„í™”)
9. [ë³´ì•ˆ ê°•í™”](#9-ë³´ì•ˆ-ê°•í™”)
10. [ëª¨ë‹ˆí„°ë§ & ì•Œë¦¼](#10-ëª¨ë‹ˆí„°ë§--ì•Œë¦¼)

---

## 1. í˜„ì¬ ì½”ë“œì˜ í•œê³„ì 

### 1.1 ë°ëª¨ ì½”ë“œ vs ì‹¤ì „ ì½”ë“œ

| í•­ëª© | í˜„ì¬ (ë°ëª¨) | ì‹¤ì „ í•„ìš” |
|------|------------|----------|
| **ì¸ì¦** | âŒ ì—†ìŒ | âœ… JWT í•„ìˆ˜ |
| **ë°ì´í„° ì €ì¥** | ë©”ëª¨ë¦¬ (íœ˜ë°œì„±) | DB (ì˜êµ¬) |
| **ë³´ì•ˆ** | ê¸°ë³¸ë§Œ | Rate Limiting, XSS ë°©ì§€ |
| **í™•ì¥ì„±** | ë‹¨ì¼ ì„œë²„ | ë‹¤ì¤‘ ì„œë²„ (Redis) |
| **ë¡œê¹…** | console.log | êµ¬ì¡°í™”ëœ ë¡œê·¸ |
| **ì—ëŸ¬ ì¶”ì ** | ê¸°ë³¸ try-catch | Sentry ë“± |
| **ëª¨ë‹ˆí„°ë§** | âŒ ì—†ìŒ | Prometheus, Grafana |

### 1.2 ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤

```javascript
// ì‹œë‚˜ë¦¬ì˜¤ 1: ì¸ì¦ ì—†ìŒ
socket.emit('create-room', 'malicious-room');
// â†’ ëˆ„êµ¬ë“  ë°© ìƒì„± ê°€ëŠ¥, ìŠ¤íŒ¸ ê³µê²© ê°€ëŠ¥

// ì‹œë‚˜ë¦¬ì˜¤ 2: ë©”ëª¨ë¦¬ íœ˜ë°œ
// ì„œë²„ ì¬ì‹œì‘ â†’ ëª¨ë“  ë°© ì‚¬ë¼ì§

// ì‹œë‚˜ë¦¬ì˜¤ 3: ë¬´ì œí•œ ìš”ì²­
while(true) {
  socket.emit('create-room', Math.random());
}
// â†’ DoS ê³µê²© ê°€ëŠ¥

// ì‹œë‚˜ë¦¬ì˜¤ 4: ë‹¨ì¼ ì„œë²„
// ì„œë²„ Aì— ìƒì„±í•œ ë°©ì„ ì„œë²„ B ì‚¬ìš©ìê°€ ëª» ë´„
```

---

## 2. ì¸ì¦ ì‹œìŠ¤í…œ (JWT)

### 2.1 ì™œ JWTê°€ í•„ìš”í•œê°€?

**ë¬¸ì œ:**
```javascript
// í˜„ì¬: ëˆ„ê°€ ì ‘ì†í–ˆëŠ”ì§€ ëª¨ë¦„
io.on('connection', (socket) => {
  console.log('ëˆ„êµ°ê°€ ì ‘ì†:', socket.id);  // ìµëª…
});
```

**í•´ê²°:**
```javascript
// JWTë¡œ ì‚¬ìš©ì ì‹ë³„
io.on('connection', (socket) => {
  console.log('í™ê¸¸ë™(ID: 123) ì ‘ì†');  // ì‹¤ëª…
});
```

### 2.2 JWT ì¸ì¦ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í”„ë¡ íŠ¸ì—”ë“œ   â”‚                  â”‚  ë©”ì¸ ì„œë²„    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                â”‚
       â”œâ”€â”€â”€ POST /api/auth/login â”€â”€â”€â”€â”€â”€â†’â”‚
       â”‚    { email, password }         â”‚
       â”‚                                â”‚
       â”‚                          [DB ì¡°íšŒ]
       â”‚                          [JWT ìƒì„±]
       â”‚                                â”‚
       â”‚â†â”€â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚    { token: "eyJhbG..." }      â”‚
       â”‚                                â”‚
       â”‚    localStorageì— ì €ì¥          â”‚
       â”‚                                â”‚
       â†“                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‹œê·¸ë„ë§ ì„œë²„ ì—°ê²° (JWT ì „ë‹¬)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ì‹œê·¸ë„ë§ ì„œë²„ JWT ì¸ì¦

```javascript
// ===== ì„¤ì¹˜ =====
// npm install jsonwebtoken

const jwt = require('jsonwebtoken');

// ===== JWT ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ =====
io.use(async (socket, next) => {
  try {
    // 1. í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ í† í° ì¶”ì¶œ
    const token = socket.handshake.auth.token;

    if (!token) {
      return next(new Error('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤'));
    }

    // 2. JWT ê²€ì¦
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    // 3. ì†Œì¼“ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
    socket.userId = decoded.userId;
    socket.username = decoded.username;
    socket.email = decoded.email;
    socket.role = decoded.role;

    console.log(`âœ… ì¸ì¦ ì„±ê³µ: ${socket.username} (ID: ${socket.userId})`);

    next();

  } catch (error) {
    console.error('âŒ ì¸ì¦ ì‹¤íŒ¨:', error.message);
    return next(new Error('ì¸ì¦ ì‹¤íŒ¨'));
  }
});

// ===== ì—°ê²° í›„ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš© ê°€ëŠ¥ =====
io.on('connection', (socket) => {
  console.log(`${socket.username}ë‹˜ ì—°ê²°`);

  socket.on('create-room', (roomId, callback) => {
    // socket.userId ì‚¬ìš© ê°€ëŠ¥
    rooms.set(roomId, {
      ownerId: socket.userId,      // â† JWTì—ì„œ ì¶”ì¶œ
      ownerName: socket.username,   // â† JWTì—ì„œ ì¶”ì¶œ
      users: new Set([socket.id])
    });
  });
});
```

### 2.4 í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ

```typescript
// ===== 1. ë¡œê·¸ì¸ =====
async function login(email: string, password: string) {
  const response = await fetch('http://localhost:8000/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  const data = await response.json();

  // JWT ì €ì¥
  localStorage.setItem('token', data.token);

  return data;
}

// ===== 2. Socket ì—°ê²° ì‹œ JWT ì „ë‹¬ =====
import { io } from 'socket.io-client';

const token = localStorage.getItem('token');

const socket = io('http://localhost:3000', {
  auth: {
    token  // â† ì„œë²„ì˜ socket.handshake.auth.tokenìœ¼ë¡œ ì „ë‹¬ë¨
  }
});

// ===== 3. ì—°ê²° ì—ëŸ¬ ì²˜ë¦¬ =====
socket.on('connect_error', (error) => {
  console.error('ì—°ê²° ì‹¤íŒ¨:', error.message);

  if (error.message === 'ì¸ì¦ ì‹¤íŒ¨') {
    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    window.location.href = '/login';
  }
});
```

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™

### 3.1 ì™œ DBê°€ í•„ìš”í•œê°€?

**í˜„ì¬ ë¬¸ì œ:**
```javascript
const rooms = new Map();  // ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥

// ì„œë²„ ì¬ì‹œì‘
// â†’ Map ì´ˆê¸°í™”
// â†’ ëª¨ë“  ë°© ì‚¬ë¼ì§
```

**í•´ê²°:**
```sql
-- PostgreSQLì— ì˜êµ¬ ì €ì¥
SELECT * FROM rooms WHERE id = 'room-123';
-- ì„œë²„ ì¬ì‹œì‘í•´ë„ ë°ì´í„° ìœ ì§€
```

### 3.2 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

```sql
-- ===== ì‚¬ìš©ì í…Œì´ë¸” =====
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  last_login TIMESTAMP
);

-- ===== ë°© í…Œì´ë¸” =====
CREATE TABLE rooms (
  id VARCHAR(255) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  owner_id INTEGER REFERENCES users(id),
  max_users INTEGER DEFAULT 10,
  status VARCHAR(20) DEFAULT 'active',  -- 'active', 'closed'
  created_at TIMESTAMP DEFAULT NOW(),
  ended_at TIMESTAMP
);

-- ===== ë°© ì°¸ì—¬ ê¸°ë¡ =====
CREATE TABLE room_participants (
  id SERIAL PRIMARY KEY,
  room_id VARCHAR(255) REFERENCES rooms(id),
  user_id INTEGER REFERENCES users(id),
  joined_at TIMESTAMP DEFAULT NOW(),
  left_at TIMESTAMP,  -- NULLì´ë©´ í˜„ì¬ ì°¸ì—¬ ì¤‘
  duration_seconds INTEGER  -- ì°¸ì—¬ ì‹œê°„ (í†µê³„ìš©)
);

-- ===== ì¸ë±ìŠ¤ (ì„±ëŠ¥ ìµœì í™”) =====
CREATE INDEX idx_rooms_status ON rooms(status);
CREATE INDEX idx_rooms_owner ON rooms(owner_id);
CREATE INDEX idx_participants_room ON room_participants(room_id);
CREATE INDEX idx_participants_user ON room_participants(user_id);
CREATE INDEX idx_participants_left ON room_participants(left_at);
```

### 3.3 PostgreSQL ì—°ë™ ì½”ë“œ

```javascript
// ===== ì„¤ì¹˜ =====
// npm install pg

const { Pool } = require('pg');

// ===== DB ì—°ê²° =====
const db = new Pool({
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || 5432,
  database: process.env.DB_NAME || 'webrtc_db',
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD,
  max: 20,  // ìµœëŒ€ ì—°ê²° ìˆ˜
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// ===== ì—°ê²° í…ŒìŠ¤íŠ¸ =====
db.connect((err, client, release) => {
  if (err) {
    console.error('âŒ DB ì—°ê²° ì‹¤íŒ¨:', err);
    process.exit(1);
  }
  console.log('âœ… DB ì—°ê²° ì„±ê³µ');
  release();
});

// ===== ì´ì¤‘ ì €ì¥ íŒ¨í„´ (DB + ë©”ëª¨ë¦¬) =====
const rooms = new Map();  // ë¹ ë¥¸ ì ‘ê·¼ìš© ìºì‹œ

socket.on('create-room', async (roomData, callback) => {
  if (!validateCallback(callback, 'create-room')) return;

  try {
    const { roomId, name, maxUsers } = roomData;

    // 1ï¸âƒ£ DBì— ë¨¼ì € ì €ì¥ (ì˜êµ¬ ë³´ê´€)
    await db.query(
      `INSERT INTO rooms (id, name, owner_id, max_users, status, created_at)
       VALUES ($1, $2, $3, $4, $5, $6)`,
      [roomId, name, socket.userId, maxUsers, 'active', new Date()]
    );

    console.log(`âœ… [DB] ë°© ìƒì„±: ${roomId}`);

    // 2ï¸âƒ£ ë©”ëª¨ë¦¬ ìºì‹œ ì €ì¥ (ë¹ ë¥¸ ì ‘ê·¼)
    rooms.set(roomId, {
      id: roomId,
      name,
      ownerId: socket.userId,
      users: new Set([socket.id]),
      createdAt: new Date()
    });

    // 3ï¸âƒ£ ì†Œì¼“ ì„¤ì •
    socket.join(roomId);
    socket.currentRoom = roomId;

    callback({ success: true, roomId });

  } catch (error) {
    console.error('âŒ ë°© ìƒì„± ì‹¤íŒ¨:', error);
    callback({ success: false, error: error.message });
  }
});

// ===== ë°© ì…ì¥ (DBì—ì„œ ë³µì› ê°€ëŠ¥) =====
socket.on('join-room', async (roomId, callback) => {
  if (!validateCallback(callback, 'join-room')) return;

  try {
    validateRoomId(roomId);

    // 1ï¸âƒ£ ë©”ëª¨ë¦¬ì—ì„œ ë¨¼ì € í™•ì¸
    let room = rooms.get(roomId);

    // 2ï¸âƒ£ ë©”ëª¨ë¦¬ì— ì—†ìœ¼ë©´ DB ì¡°íšŒ (ì„œë²„ ì¬ì‹œì‘ í›„)
    if (!room) {
      const result = await db.query(
        `SELECT * FROM rooms WHERE id = $1 AND status = $2`,
        [roomId, 'active']
      );

      if (result.rows.length === 0) {
        throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤');
      }

      // DB ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë³µì›
      const dbRoom = result.rows[0];
      room = {
        id: roomId,
        name: dbRoom.name,
        ownerId: dbRoom.owner_id,
        users: new Set(),
        createdAt: dbRoom.created_at
      };
      rooms.set(roomId, room);

      console.log(`ğŸ”„ [ë³µì›] DBì—ì„œ ë°© ë¡œë“œ: ${roomId}`);
    }

    // 3ï¸âƒ£ ìµœëŒ€ ì¸ì› í™•ì¸
    const roomInfo = await db.query(
      'SELECT max_users FROM rooms WHERE id = $1',
      [roomId]
    );

    if (room.users.size >= roomInfo.rows[0].max_users) {
      throw new Error('ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤');
    }

    // 4ï¸âƒ£ DBì— ì°¸ì—¬ ê¸°ë¡
    await db.query(
      `INSERT INTO room_participants (room_id, user_id, joined_at)
       VALUES ($1, $2, $3)`,
      [roomId, socket.userId, new Date()]
    );

    // 5ï¸âƒ£ ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
    const existingUsers = Array.from(room.users);
    room.users.add(socket.id);

    socket.join(roomId);
    socket.currentRoom = roomId;

    // 6ï¸âƒ£ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    socket.to(roomId).emit('user-joined', {
      userId: socket.userId,
      username: socket.username
    });

    callback({ success: true, roomId, existingUsers });

  } catch (error) {
    console.error('âŒ ë°© ì…ì¥ ì‹¤íŒ¨:', error);
    callback({ success: false, error: error.message });
  }
});

// ===== disconnect ì‹œ DB ì—…ë°ì´íŠ¸ =====
socket.on('disconnect', async (reason) => {
  if (socket.currentRoom) {
    const room = rooms.get(socket.currentRoom);

    if (room) {
      room.users.delete(socket.id);

      // 1ï¸âƒ£ DBì— í‡´ì¥ ì‹œê°„ ê¸°ë¡
      const result = await db.query(
        `UPDATE room_participants
         SET left_at = $1,
             duration_seconds = EXTRACT(EPOCH FROM ($1 - joined_at))
         WHERE room_id = $2 AND user_id = $3 AND left_at IS NULL
         RETURNING duration_seconds`,
        [new Date(), socket.currentRoom, socket.userId]
      );

      console.log(`âœ… [DB] ${socket.username} í‡´ì¥ (${result.rows[0]?.duration_seconds}ì´ˆ)`);

      // 2ï¸âƒ£ ë§ˆì§€ë§‰ ì‚¬ìš©ì í‡´ì¥ â†’ ë°© ì¢…ë£Œ
      if (room.users.size === 0) {
        rooms.delete(socket.currentRoom);

        await db.query(
          `UPDATE rooms
           SET status = $1, ended_at = $2
           WHERE id = $3`,
          ['closed', new Date(), socket.currentRoom]
        );

        console.log(`âœ… [DB] ë°© ì¢…ë£Œ: ${socket.currentRoom}`);
      }
    }
  }
});
```

---

## 4. Rate Limiting

### 4.1 ì™œ í•„ìš”í•œê°€?

**ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:**
```javascript
// ì•…ì˜ì  í´ë¼ì´ì–¸íŠ¸
while(true) {
  socket.emit('create-room', Math.random());
}
// â†’ ì„œë²„ ê³¼ë¶€í•˜, ë©”ëª¨ë¦¬ ê³ ê°ˆ
```

### 4.2 Rate Limiter êµ¬í˜„

```javascript
// ===== ì—°ê²° ì œí•œ (IP ê¸°ë°˜) =====
const connectionLimiters = new Map();

io.use((socket, next) => {
  const ip = socket.handshake.address;

  const limiter = connectionLimiters.get(ip) || {
    count: 0,
    resetAt: Date.now() + 60000  // 1ë¶„ í›„ ë¦¬ì…‹
  };

  if (Date.now() > limiter.resetAt) {
    limiter.count = 0;
    limiter.resetAt = Date.now() + 60000;
  }

  limiter.count++;

  if (limiter.count > 10) {  // 1ë¶„ì— 10ë²ˆ ì œí•œ
    return next(new Error('ì—°ê²° ì‹œë„ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'));
  }

  connectionLimiters.set(ip, limiter);
  next();
});

// ===== ì´ë²¤íŠ¸ë³„ Rate Limiting =====
class RateLimiter {
  constructor(maxRequests, windowMs) {
    this.maxRequests = maxRequests;
    this.windowMs = windowMs;
    this.requests = new Map();
  }

  check(userId) {
    const now = Date.now();
    const userRequests = this.requests.get(userId) || [];

    // ìœˆë„ìš° ë°– ìš”ì²­ ì œê±°
    const validRequests = userRequests.filter(
      time => now - time < this.windowMs
    );

    if (validRequests.length >= this.maxRequests) {
      return false;  // ì œí•œ ì´ˆê³¼
    }

    validRequests.push(now);
    this.requests.set(userId, validRequests);

    return true;  // í†µê³¼
  }
}

// ===== ì‚¬ìš© =====
const createRoomLimiter = new RateLimiter(5, 60000);  // 1ë¶„ì— 5ë²ˆ

socket.on('create-room', (roomData, callback) => {
  if (!validateCallback(callback, 'create-room')) return;

  // Rate Limiting ì²´í¬
  if (!createRoomLimiter.check(socket.userId)) {
    return callback({
      success: false,
      error: 'ë°© ìƒì„± ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'
    });
  }

  // ì •ìƒ ì²˜ë¦¬
  // ...
});
```

---

## 5. ë°© ìµœëŒ€ ì¸ì› ì œí•œ

### 5.1 í˜„ì¬ ë¬¸ì œ

```javascript
// í˜„ì¬: ë¬´ì œí•œ ì…ì¥ ê°€ëŠ¥
socket.on('join-room', (roomId, callback) => {
  room.users.add(socket.id);  // ì œí•œ ì—†ìŒ
});
```

### 5.2 ê°œì„  ì½”ë“œ

```javascript
socket.on('join-room', async (roomId, callback) => {
  if (!validateCallback(callback, 'join-room')) return;

  try {
    validateRoomId(roomId);

    // DBì—ì„œ ë°© ì •ë³´ ì¡°íšŒ
    const result = await db.query(
      `SELECT max_users FROM rooms WHERE id = $1 AND status = $2`,
      [roomId, 'active']
    );

    if (result.rows.length === 0) {
      throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤');
    }

    const room = rooms.get(roomId);
    const maxUsers = result.rows[0].max_users;

    // âœ… ìµœëŒ€ ì¸ì› ì²´í¬
    if (room.users.size >= maxUsers) {
      throw new Error(`ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ ${maxUsers}ëª…)`);
    }

    // ì…ì¥ ì²˜ë¦¬
    room.users.add(socket.id);
    // ...

  } catch (error) {
    callback({ success: false, error: error.message });
  }
});
```

---

## 6. Redis ë‹¤ì¤‘ ì„œë²„ í™•ì¥

### 6.1 ë¬¸ì œ: ë‹¨ì¼ ì„œë²„ì˜ í•œê³„

```
[ì„œë²„ A]              [ì„œë²„ B]
rooms.set('room-1')   rooms.set('room-2')
     â†“                     â†“
ì„œë¡œ ë‹¤ë¥¸ ë©”ëª¨ë¦¬ â†’ ë°ì´í„° ê³µìœ  ì•ˆ ë¨!

ì‚¬ìš©ì A (ì„œë²„ Aì— ì—°ê²°) â”€â•³â”€ ì‚¬ìš©ì B (ì„œë²„ Bì— ì—°ê²°)
```

### 6.2 í•´ê²°: Redisë¡œ ìƒíƒœ ê³µìœ 

```
[ì„œë²„ A]    [ì„œë²„ B]    [ì„œë²„ C]
   â†“           â†“           â†“
   â””â”€â”€â”€â”€â”€â”€â”€â†’ Redis â†â”€â”€â”€â”€â”€â”€â”€â”˜
         (ì¤‘ì•™ ì €ì¥ì†Œ)
```

### 6.3 Redis Adapter ì„¤ì •

```javascript
// ===== ì„¤ì¹˜ =====
// npm install redis @socket.io/redis-adapter

const { createClient } = require('redis');
const { createAdapter } = require('@socket.io/redis-adapter');

// ===== Redis í´ë¼ì´ì–¸íŠ¸ ìƒì„± =====
const pubClient = createClient({
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379
});

const subClient = pubClient.duplicate();

Promise.all([pubClient.connect(), subClient.connect()]).then(() => {
  // ===== Socket.ioì— Redis Adapter ì ìš© =====
  io.adapter(createAdapter(pubClient, subClient));

  console.log('âœ… Redis Adapter ì—°ê²° ì™„ë£Œ');
});

// ===== ë°© ì •ë³´ë¥¼ Redisì— ì €ì¥ =====
socket.on('create-room', async (roomData, callback) => {
  if (!validateCallback(callback, 'create-room')) return;

  try {
    const { roomId, name, maxUsers } = roomData;

    // 1ï¸âƒ£ DB ì €ì¥
    await db.query(/* ... */);

    // 2ï¸âƒ£ Redis ì €ì¥ (ì„œë²„ ê°„ ê³µìœ )
    await pubClient.hSet(`room:${roomId}`, {
      id: roomId,
      name,
      ownerId: socket.userId,
      ownerName: socket.username,
      maxUsers,
      createdAt: new Date().toISOString()
    });

    // TTL ì„¤ì • (24ì‹œê°„ í›„ ìë™ ì‚­ì œ)
    await pubClient.expire(`room:${roomId}`, 86400);

    // 3ï¸âƒ£ ë©”ëª¨ë¦¬ ìºì‹œ
    rooms.set(roomId, {
      id: roomId,
      users: new Set([socket.id])
    });

    socket.join(roomId);
    socket.currentRoom = roomId;

    callback({ success: true, roomId });

  } catch (error) {
    callback({ success: false, error: error.message });
  }
});

// ===== ë°© ì…ì¥ (Redisì—ì„œ ì¡°íšŒ) =====
socket.on('join-room', async (roomId, callback) => {
  if (!validateCallback(callback, 'join-room')) return;

  try {
    // 1ï¸âƒ£ Redisì—ì„œ ë°© ì •ë³´ ì¡°íšŒ
    const roomData = await pubClient.hGetAll(`room:${roomId}`);

    if (!roomData || !roomData.id) {
      throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤');
    }

    // 2ï¸âƒ£ í˜„ì¬ ì°¸ì—¬ ì¸ì› í™•ì¸
    const sockets = await io.in(roomId).fetchSockets();

    if (sockets.length >= parseInt(roomData.maxUsers)) {
      throw new Error('ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤');
    }

    // 3ï¸âƒ£ ì…ì¥ ì²˜ë¦¬
    socket.join(roomId);
    socket.currentRoom = roomId;

    // 4ï¸âƒ£ DB ê¸°ë¡
    await db.query(/* ... */);

    // 5ï¸âƒ£ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (ëª¨ë“  ì„œë²„ì˜ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬)
    socket.to(roomId).emit('user-joined', {
      userId: socket.userId,
      username: socket.username
    });

    callback({ success: true, roomId });

  } catch (error) {
    callback({ success: false, error: error.message });
  }
});
```

---

## 7. ë¡œê¹… ì‹œìŠ¤í…œ

### 7.1 í˜„ì¬ ë¬¸ì œ

```javascript
console.log('[ë°© ìƒì„±]', roomId);  // êµ¬ì¡°í™” ì•ˆ ë¨
console.error('ì—ëŸ¬:', error);      // ê²€ìƒ‰ ì–´ë ¤ì›€
```

### 7.2 Winston ë¡œê¹…

```javascript
// ===== ì„¤ì¹˜ =====
// npm install winston

const winston = require('winston');

// ===== ë¡œê±° ì„¤ì • =====
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'signaling-server' },
  transports: [
    // íŒŒì¼ ì €ì¥
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error'
    }),
    new winston.transports.File({
      filename: 'logs/combined.log'
    })
  ]
});

// ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì½˜ì†” ì¶œë ¥
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}

// ===== ì‚¬ìš© =====
io.on('connection', (socket) => {
  logger.info('ìƒˆ ì—°ê²°', {
    socketId: socket.id,
    userId: socket.userId,
    username: socket.username,
    ip: socket.handshake.address
  });

  socket.on('create-room', async (roomData, callback) => {
    try {
      // ...

      logger.info('ë°© ìƒì„±', {
        roomId,
        userId: socket.userId,
        username: socket.username,
        maxUsers
      });

      callback({ success: true, roomId });

    } catch (error) {
      logger.error('ë°© ìƒì„± ì‹¤íŒ¨', {
        roomId,
        userId: socket.userId,
        error: error.message,
        stack: error.stack
      });

      callback({ success: false, error: error.message });
    }
  });
});
```

---

## 8. ì—ëŸ¬ ì²˜ë¦¬ ê³ ë„í™”

### 8.1 ì»¤ìŠ¤í…€ ì—ëŸ¬ í´ë˜ìŠ¤

```javascript
// ===== ì—ëŸ¬ íƒ€ì… ì •ì˜ =====
class SignalingError extends Error {
  constructor(message, code, statusCode = 500) {
    super(message);
    this.name = this.constructor.name;
    this.code = code;
    this.statusCode = statusCode;
    Error.captureStackTrace(this, this.constructor);
  }
}

class ValidationError extends SignalingError {
  constructor(message) {
    super(message, 'VALIDATION_ERROR', 400);
  }
}

class AuthenticationError extends SignalingError {
  constructor(message) {
    super(message, 'AUTH_ERROR', 401);
  }
}

class RoomFullError extends SignalingError {
  constructor(message) {
    super(message, 'ROOM_FULL', 403);
  }
}

class RateLimitError extends SignalingError {
  constructor(message) {
    super(message, 'RATE_LIMIT', 429);
  }
}

// ===== ì‚¬ìš© =====
socket.on('join-room', async (roomId, callback) => {
  try {
    validateRoomId(roomId);  // ValidationError throw ê°€ëŠ¥

    if (!createRoomLimiter.check(socket.userId)) {
      throw new RateLimitError('ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤');
    }

    const room = rooms.get(roomId);
    if (room.users.size >= maxUsers) {
      throw new RoomFullError(`ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ ${maxUsers}ëª…)`);
    }

    // ...

  } catch (error) {
    logger.error('ë°© ì…ì¥ ì‹¤íŒ¨', {
      error: error.message,
      code: error.code,
      userId: socket.userId
    });

    callback({
      success: false,
      error: {
        message: error.message,
        code: error.code
      }
    });
  }
});
```

### 8.2 ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬

```javascript
// ===== Socket ì—ëŸ¬ í•¸ë“¤ëŸ¬ =====
io.on('connection', (socket) => {
  socket.on('error', (error) => {
    logger.error('Socket ì—ëŸ¬', {
      socketId: socket.id,
      userId: socket.userId,
      error: error.message
    });
  });
});

// ===== ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì—ëŸ¬ =====
process.on('uncaughtException', (error) => {
  logger.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸', {
    error: error.message,
    stack: error.stack
  });

  // Graceful shutdown
  io.close(() => {
    process.exit(1);
  });
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€', {
    reason,
    promise
  });
});
```

---

## 9. ë³´ì•ˆ ê°•í™”

### 9.1 Helmet (ë³´ì•ˆ í—¤ë”)

```javascript
// ===== ì„¤ì¹˜ =====
// npm install helmet

const helmet = require('helmet');

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      connectSrc: ["'self'", "ws://localhost:3000"]
    }
  }
}));
```

### 9.2 CORS ê°•í™”

```javascript
const io = socketIO(server, {
  cors: {
    origin: (origin, callback) => {
      const allowedOrigins = [
        'http://localhost:5173',
        'https://yourdomain.com'
      ];

      if (!origin || allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('CORS ì •ì±… ìœ„ë°˜'));
      }
    },
    methods: ['GET', 'POST'],
    credentials: true
  }
});
```

### 9.3 ì…ë ¥ ê²€ì¦ ê°•í™”

```javascript
// ===== validator ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© =====
// npm install validator

const validator = require('validator');

function validateRoomId(roomId) {
  if (!roomId || typeof roomId !== 'string') {
    throw new ValidationError('ìœ íš¨í•˜ì§€ ì•Šì€ ë°© ID');
  }

  // XSS ë°©ì§€
  if (!validator.isAlphanumeric(roomId, 'en-US', { ignore: '-_' })) {
    throw new ValidationError('ë°© IDì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
  }

  if (roomId.length < 3 || roomId.length > 100) {
    throw new ValidationError('ë°© IDëŠ” 3-100ìì—¬ì•¼ í•©ë‹ˆë‹¤');
  }
}

function validateRoomName(name) {
  if (!name || typeof name !== 'string') {
    throw new ValidationError('ìœ íš¨í•˜ì§€ ì•Šì€ ë°© ì´ë¦„');
  }

  // HTML íƒœê·¸ ì œê±° (XSS ë°©ì§€)
  const sanitized = validator.escape(name);

  if (sanitized.length < 2 || sanitized.length > 50) {
    throw new ValidationError('ë°© ì´ë¦„ì€ 2-50ìì—¬ì•¼ í•©ë‹ˆë‹¤');
  }

  return sanitized;
}
```

---

## 10. ëª¨ë‹ˆí„°ë§ & ì•Œë¦¼

### 10.1 Prometheus ë©”íŠ¸ë¦­

```javascript
// ===== ì„¤ì¹˜ =====
// npm install prom-client

const promClient = require('prom-client');

// ===== ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒì„± =====
const register = new promClient.Registry();

// ===== ë©”íŠ¸ë¦­ ì •ì˜ =====
const activeConnections = new promClient.Gauge({
  name: 'signaling_active_connections',
  help: 'í˜„ì¬ í™œì„± ì—°ê²° ìˆ˜',
  registers: [register]
});

const activeRooms = new promClient.Gauge({
  name: 'signaling_active_rooms',
  help: 'í˜„ì¬ í™œì„± ë°© ìˆ˜',
  registers: [register]
});

const roomCreated = new promClient.Counter({
  name: 'signaling_rooms_created_total',
  help: 'ìƒì„±ëœ ì´ ë°© ìˆ˜',
  registers: [register]
});

const connectionDuration = new promClient.Histogram({
  name: 'signaling_connection_duration_seconds',
  help: 'ì—°ê²° ì§€ì† ì‹œê°„',
  buckets: [1, 5, 15, 30, 60, 300, 600, 1800, 3600],
  registers: [register]
});

// ===== ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì—”ë“œí¬ì¸íŠ¸ =====
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});

// ===== ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸ =====
io.on('connection', (socket) => {
  const connectionStart = Date.now();

  activeConnections.inc();

  socket.on('create-room', async (roomData, callback) => {
    // ...
    roomCreated.inc();
    activeRooms.inc();
  });

  socket.on('disconnect', () => {
    activeConnections.dec();

    const duration = (Date.now() - connectionStart) / 1000;
    connectionDuration.observe(duration);
  });
});

// ===== ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ =====
setInterval(() => {
  activeRooms.set(rooms.size);
}, 5000);
```

### 10.2 Grafana ëŒ€ì‹œë³´ë“œ

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'signaling-server'
    static_configs:
      - targets: ['localhost:3000']
```

---

## 11. ì „ì²´ êµ¬ì¡° (ì‹¤ì „ ë²„ì „)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í”„ë¡ íŠ¸ì—”ë“œ                         â”‚
â”‚                (React + Socket.io)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ JWT í† í° ì „ë‹¬
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ë¡œë“œ ë°¸ëŸ°ì„œ (Nginx)                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                 â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì„œë²„ A    â”‚     â”‚ ì„œë²„ B    â”‚     â”‚ ì„œë²„ C    â”‚
â”‚ (Node.js)â”‚     â”‚ (Node.js)â”‚     â”‚ (Node.js)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Redis   â”‚    â”‚ PostgreSQL â”‚
       â”‚  (ìƒíƒœ)   â”‚    â”‚  (ì˜êµ¬DB)  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Prometheus + Grafana     â”‚
       â”‚      (ëª¨ë‹ˆí„°ë§)             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```bash
# ===== .env =====

# ì„œë²„
PORT=3000
NODE_ENV=production

# JWT
JWT_SECRET=your-super-secret-key-change-this

# DB
DB_HOST=localhost
DB_PORT=5432
DB_NAME=webrtc_db
DB_USER=postgres
DB_PASSWORD=your-db-password

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# CORS
CLIENT_URL=https://yourdomain.com

# ë¡œê¹…
LOG_LEVEL=info
```

---

## 13. ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] JWT ì¸ì¦ êµ¬í˜„
- [ ] PostgreSQL ì—°ë™
- [ ] Redis í´ëŸ¬ìŠ¤í„° ì„¤ì •
- [ ] Rate Limiting ì ìš©
- [ ] Winston ë¡œê¹…
- [ ] Helmet ë³´ì•ˆ í—¤ë”
- [ ] CORS í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] Prometheus ë©”íŠ¸ë¦­
- [ ] Grafana ëŒ€ì‹œë³´ë“œ
- [ ] ì—ëŸ¬ ì¶”ì  (Sentry)
- [ ] ë¡œë“œ ë°¸ëŸ°ì„œ ì„¤ì •
- [ ] SSL/TLS ì¸ì¦ì„œ
- [ ] ë°±ì—… ìë™í™”
- [ ] ëª¨ë‹ˆí„°ë§ ì•Œë¦¼

---

## 14. ë‹¤ìŒ ë‹¨ê³„

1. **ê°œë°œ í™˜ê²½ êµ¬ì¶•**: Docker Composeë¡œ ë¡œì»¬ í™˜ê²½ ì„¤ì •
2. **ë‹¨ê³„ë³„ êµ¬í˜„**: ì¸ì¦ â†’ DB â†’ Redis ìˆœì„œë¡œ ì¶”ê°€
3. **í…ŒìŠ¤íŠ¸ ì‘ì„±**: Jest + Supertestë¡œ ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸
4. **ì„±ëŠ¥ ìµœì í™”**: ë¶€í•˜ í…ŒìŠ¤íŠ¸ (Artillery, k6)
5. **ë°°í¬ ìë™í™”**: CI/CD íŒŒì´í”„ë¼ì¸ (GitHub Actions)

---

**ë‹¤ìŒ í•™ìŠµ íŒŒì¼:**
- [Dockerë¡œ ê°œë°œ í™˜ê²½ êµ¬ì¶•](./Docker_ê°œë°œí™˜ê²½_êµ¬ì¶•.md)
- [í…ŒìŠ¤íŠ¸ ì‘ì„± ê°€ì´ë“œ](./í…ŒìŠ¤íŠ¸_ì‘ì„±_ê°€ì´ë“œ.md)
- [ì„±ëŠ¥ ìµœì í™” ì „ëµ](./ì„±ëŠ¥_ìµœì í™”_ì „ëµ.md)
