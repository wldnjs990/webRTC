# WebRTC í™”ìƒì±„íŒ… êµ¬í˜„ ì™„ë²½ ê°€ì´ë“œ

> ì£¼ë‹ˆì–´ ê°œë°œìë¥¼ ìœ„í•œ WebRTC + Socket.IO ì‹¤ì „ ê°€ì´ë“œ
> ì‘ì„±ì¼: 2026-01-05

---

## ğŸ“š ëª©ì°¨

1. [WebRTC í•µì‹¬ ê°œë…](#1-webrtc-í•µì‹¬-ê°œë…)
2. [ì „ì²´ ì•„í‚¤í…ì²˜](#2-ì „ì²´-ì•„í‚¤í…ì²˜)
3. [í†µì‹  íë¦„ ì™„ë²½ ë¶„ì„](#3-í†µì‹ -íë¦„-ì™„ë²½-ë¶„ì„)
4. [ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œ](#4-ìƒì„¸-êµ¬í˜„-ê°€ì´ë“œ)
5. [í•µì‹¬ ì´ë²¤íŠ¸ íƒ€ì´ë°](#5-í•µì‹¬-ì´ë²¤íŠ¸-íƒ€ì´ë°)
6. [í™•ì¥ ê¸°ëŠ¥ êµ¬í˜„ í¬ì¸íŠ¸](#6-í™•ì¥-ê¸°ëŠ¥-êµ¬í˜„-í¬ì¸íŠ¸)
7. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#7-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## 1. WebRTC í•µì‹¬ ê°œë…

### 1.1 WebRTCë€?

**Web Real-Time Communication**ì˜ ì•½ìë¡œ, ë¸Œë¼ìš°ì € ê°„ **P2P(Peer-to-Peer)** ë°©ì‹ìœ¼ë¡œ ì‹¤ì‹œê°„ ë¯¸ë””ì–´(ì˜¤ë””ì˜¤, ë¹„ë””ì˜¤, ë°ì´í„°)ë¥¼ ì „ì†¡í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

#### í•µì‹¬ íŠ¹ì§•

```
í´ë¼ì´ì–¸íŠ¸ A â†â”€â”€â”€â”€â”€â”€â”€â”€ ì§ì ‘ ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â†’ í´ë¼ì´ì–¸íŠ¸ B
(ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼)                         (ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼)
      â†“                                      â†“
   ë¸Œë¼ìš°ì €                                ë¸Œë¼ìš°ì €

âš ï¸ ì„œë²„ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì§ì ‘ ì „ì†¡! (ë‚®ì€ ì§€ì—°ì‹œê°„)
```

### 1.2 ì™œ Socket.IOê°€ í•„ìš”í•œê°€?

WebRTCëŠ” P2P ì—°ê²°ì´ì§€ë§Œ, **ìµœì´ˆ ì—°ê²°ì„ ë§ºê¸° ìœ„í•œ ì •ë³´ êµí™˜**ì€ ì„œë²„ê°€ ì¤‘ê³„í•´ì•¼ í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í´ë¼ A     â”‚                          â”‚  í´ë¼ B     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                        â”‚
       â”‚  â‘  "Bì•¼, ë‚˜ë‘ ì—°ê²°í• ë˜?"(Offer)        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚            â”‚          â”‚                â”‚
       â”‚            â”‚  ì„œë²„    â”‚                â”‚
       â”‚  â‘¢ Answer  â”‚ (ì‹œê·¸ë„ë§)â”‚  â‘¡ Offer ì „ë‹¬   â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚            â”‚          â”‚                â”‚
       â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
       â”‚                                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€  â‘£ P2P ì§ì ‘ ì—°ê²°! â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (ì´ì œ ì„œë²„ í•„ìš”ì—†ìŒ)
```

**ì—­í•  ë¶„ë¦¬:**
- **Socket.IO**: ì‹œê·¸ë„ë§(Offer/Answer/ICE êµí™˜) - ì—°ê²° ì„¤ì • ë‹¨ê³„
- **WebRTC**: ì‹¤ì œ ë¯¸ë””ì–´ ì „ì†¡ - P2P ë°ì´í„° ì „ì†¡

---

## 2. ì „ì²´ ì•„í‚¤í…ì²˜

### 2.1 ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (React)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              VideoChat Component (UI)              â”‚    â”‚
â”‚  â”‚  - ë°© ì…ì¥/ìƒì„± UI                                   â”‚    â”‚
â”‚  â”‚  - ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ                                      â”‚    â”‚
â”‚  â”‚  - ì»¨íŠ¸ë¡¤ ë²„íŠ¼                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           useVideoChat (í†µí•© ë ˆì´ì–´)                â”‚    â”‚
â”‚  â”‚  - í›… í†µí•© ë° ìë™ Offer ì „ì†¡ ë¡œì§                    â”‚    â”‚
â”‚  â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚    â”‚             â”‚             â”‚                          â”‚
â”‚  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚useLocalâ”‚  â”‚useWebRTCâ”‚  â”‚   useRoom   â”‚               â”‚
â”‚  â”‚Stream  â”‚  â”‚         â”‚  â”‚             â”‚               â”‚
â”‚  â”‚        â”‚  â”‚         â”‚  â”‚             â”‚               â”‚
â”‚  â”‚ì¹´ë©”ë¼/ â”‚  â”‚P2P ì—°ê²° â”‚  â”‚ë°© ê´€ë¦¬    â”‚               â”‚
â”‚  â”‚ë§ˆì´í¬  â”‚  â”‚ê´€ë¦¬     â”‚  â”‚Socket.IO  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                   â”‚               â”‚                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚   useSocket (ì‹±ê¸€í†¤)    â”‚                  â”‚
â”‚              â”‚  - WebSocket ì—°ê²° ê´€ë¦¬   â”‚                  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ Socket.IO
                            â”‚ (ì‹œê·¸ë„ë§)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Backend (Node.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚            Socket.IO Server (server.js)          â”‚     â”‚
â”‚  â”‚                                                  â”‚     â”‚
â”‚  â”‚  â€¢ ë°© ìƒì„±/ì…ì¥/í‡´ì¥ ê´€ë¦¬                         â”‚     â”‚
â”‚  â”‚  â€¢ Offer/Answer/ICE Candidate ì¤‘ê³„              â”‚     â”‚
â”‚  â”‚  â€¢ ì‚¬ìš©ì ì—°ê²°/í•´ì œ ì´ë²¤íŠ¸ ì²˜ë¦¬                    â”‚     â”‚
â”‚  â”‚                                                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚     â”‚
â”‚  â”‚  â”‚   Map<roomId, Room>            â”‚             â”‚     â”‚
â”‚  â”‚  â”‚   {                            â”‚             â”‚     â”‚
â”‚  â”‚  â”‚     id: string,                â”‚             â”‚     â”‚
â”‚  â”‚  â”‚     users: Set<socketId>,      â”‚             â”‚     â”‚
â”‚  â”‚  â”‚     createdAt: timestamp       â”‚             â”‚     â”‚
â”‚  â”‚  â”‚   }                            â”‚             â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ ì¤‘ìš”: ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì€ ì„œë²„ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  í´ë¼ì´ì–¸íŠ¸ë¼ë¦¬ ì§ì ‘ P2Pë¡œ ì „ì†¡!
```

### 2.2 ì±…ì„ ë¶„ë¦¬ (Separation of Concerns)

| ëª¨ë“ˆ | ì±…ì„ | ì£¼ìš” ê¸°ëŠ¥ |
|------|------|-----------|
| **useSocket** | WebSocket ì—°ê²° ê´€ë¦¬ | - ì‹±ê¸€í†¤ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤<br>- ì—°ê²° ìƒíƒœ ê´€ë¦¬<br>- ìë™ ì¬ì—°ê²° |
| **useLocalStream** | ë¡œì»¬ ë¯¸ë””ì–´ ì œì–´ | - ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼<br>- íŠ¸ë™ on/off<br>- ìŠ¤íŠ¸ë¦¼ ì •ë¦¬ |
| **useWebRTC** | P2P ì—°ê²° ê´€ë¦¬ | - RTCPeerConnection ìƒì„±<br>- Offer/Answer ì²˜ë¦¬<br>- ICE Candidate êµí™˜<br>- ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  |
| **useRoom** | ë°© ìƒíƒœ ê´€ë¦¬ | - ë°© ìƒì„±/ì…ì¥/í‡´ì¥<br>- ì°¸ì—¬ì ëª©ë¡ ê´€ë¦¬<br>- user-joined ì´ë²¤íŠ¸ ì²˜ë¦¬ |
| **useVideoChat** | í†µí•© ë¡œì§ | - í›… í†µí•©<br>- ìë™ Offer ì „ì†¡<br>- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¡°ìœ¨ |
| **VideoChat** | UI ë Œë”ë§ | - ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤<br>- ì´ë²¤íŠ¸ í•¸ë“¤ë§ |

---

## 3. í†µì‹  íë¦„ ì™„ë²½ ë¶„ì„

### 3.1 ì‹œë‚˜ë¦¬ì˜¤: Aê°€ ë°©ì„ ë§Œë“¤ê³ , Bê°€ ì…ì¥í•˜ëŠ” ê²½ìš°

#### Phase 1: ì‚¬ìš©ì A - ë°© ìƒì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A í´ë¼  â”‚                                    â”‚  ì„œë²„   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                              â”‚
     â”‚  1. createRoom('room-123')                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚      emit('create-room', roomId, callback)   â”‚
     â”‚                                              â”‚
     â”‚                                              â”‚  rooms.set('room-123', {
     â”‚                                              â”‚    id: 'room-123',
     â”‚                                              â”‚    users: Set(['A-socket-id']),
     â”‚                                              â”‚    createdAt: timestamp
     â”‚                                              â”‚  })
     â”‚                                              â”‚
     â”‚  2. callback({ success: true, roomId })      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                              â”‚
     â”‚  setRoomId('room-123')                       â”‚
     â”‚
     â””â”€ âœ… AëŠ” ë°©ì—ì„œ ëŒ€ê¸° ì¤‘
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- `callback` íŒ¨í„´: ìƒì„±ìì—ê²Œë§Œ ì‘ë‹µ (1:1 í†µì‹ )
- ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì—†ìŒ (ì•„ì§ ë³¸ì¸ë§Œ ìˆìŒ)

---

#### Phase 2: ì‚¬ìš©ì B - ë°© ì…ì¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B í´ë¼  â”‚                                    â”‚  ì„œë²„   â”‚                                    â”‚ A í´ë¼  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  1. joinRoom('room-123')                     â”‚                                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                              â”‚
     â”‚      emit('join-room', roomId, callback)     â”‚                                              â”‚
     â”‚                                              â”‚                                              â”‚
     â”‚                                              â”‚  room.users.add('B-socket-id')              â”‚
     â”‚                                              â”‚                                              â”‚
     â”‚  2. callback({                               â”‚  3. emit('user-joined', { userId: 'B' })    â”‚
     â”‚       success: true,                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚       roomId: 'room-123',                    â”‚    (broadcast to A)                          â”‚
     â”‚       existingUsers: ['A-socket-id']         â”‚                                              â”‚
     â”‚     })                                       â”‚                                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                              â”‚
     â”‚                                              â”‚                                              â”‚
     â”‚  setRoomId('room-123')                       â”‚                                              â”‚  A: handleUserJoined()
     â”‚  setExistingUsers(['A-socket-id'])           â”‚                                              â”‚  setNewUser('B-socket-id')
     â”‚                                              â”‚                                              â”‚
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- **Callback**: Bì—ê²Œ ê¸°ì¡´ ì°¸ì—¬ì ëª©ë¡(`existingUsers`) ì „ë‹¬
- **Broadcast**: Aì—ê²Œ ìƒˆ ì°¸ì—¬ì ì…ì¥(`user-joined`) ì•Œë¦¼
- ì–‘ìª½ ëª¨ë‘ ìƒëŒ€ë°© ì •ë³´ë¥¼ íšë“!

---

#### Phase 3: WebRTC Offer/Answer êµí™˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B í´ë¼  â”‚                                    â”‚  ì„œë²„   â”‚                                    â”‚ A í´ë¼  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  useEffect ê°ì§€:                              â”‚                                              â”‚  useEffect ê°ì§€:
     â”‚  existingUsers = ['A']                       â”‚                                              â”‚  newUser = 'B'
     â”‚  localStream ì¡´ì¬                             â”‚                                              â”‚  localStream ì¡´ì¬
     â”‚                                              â”‚                                              â”‚
     â”‚  4. sendOffer('A-socket-id')                 â”‚                                              â”‚  4. sendOffer('B-socket-id')
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚ new RTCPeerConnection  â”‚                  â”‚                                              â”‚  â”‚ new RTCPeerConnection  â”‚
     â”‚  â”‚ pc.addTrack(videoTrack)â”‚                  â”‚                                              â”‚  â”‚ pc.addTrack(videoTrack)â”‚
     â”‚  â”‚ pc.addTrack(audioTrack)â”‚                  â”‚                                              â”‚  â”‚ pc.addTrack(audioTrack)â”‚
     â”‚  â”‚ offer = createOffer()  â”‚                  â”‚                                              â”‚  â”‚ offer = createOffer()  â”‚
     â”‚  â”‚ setLocalDescription()  â”‚                  â”‚                                              â”‚  â”‚ setLocalDescription()  â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  emit('offer', { target: 'A', offer })       â”‚                                              â”‚  emit('offer', { target: 'B', offer })
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                              â”‚                                              â”‚                              â”‚
     â”‚                                              â”‚  5. emit('offer', { from: 'B', offer })      â”‚                              â”‚
     â”‚                                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
     â”‚                                              â”‚                                              â”‚                              â”‚
     â”‚                                              â”‚  5. emit('offer', { from: 'A', offer })      â”‚                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                              â”‚                                              â”‚
```

**âš ï¸ ì¤‘ìš”: ì–‘ë°©í–¥ Offer ë°œìƒ!**

ì™œ ë‘ ëª…ì´ ë™ì‹œì— Offerë¥¼ ë³´ë‚´ë‚˜ìš”?
- **B â†’ A**: BëŠ” `existingUsers`ì—ì„œ Aë¥¼ ë°œê²¬ â†’ Aì—ê²Œ offer
- **A â†’ B**: AëŠ” `user-joined` ì´ë²¤íŠ¸ë¡œ B ê°ì§€ â†’ Bì—ê²Œ offer

ì´ê²ƒì´ **Mesh Topology**ì˜ íŠ¹ì§•ì…ë‹ˆë‹¤. ê°ì ìƒëŒ€ë°©ì—ê²Œ ì—°ê²° ìš”ì²­!

---

#### Phase 4: Offer ìˆ˜ì‹  ë° Answer ì‘ë‹µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B í´ë¼  â”‚                                    â”‚  ì„œë²„   â”‚                                    â”‚ A í´ë¼  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  6. on('offer') - Aì˜ offer ìˆ˜ì‹               â”‚                                              â”‚  6. on('offer') - Bì˜ offer ìˆ˜ì‹ 
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚ handleOffer({ from: 'A', ... })â”‚           â”‚                                              â”‚  â”‚ handleOffer({ from: 'B', ... })â”‚
     â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚           â”‚                                              â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
     â”‚  â”‚ new RTCPeerConnection          â”‚           â”‚                                              â”‚  â”‚ new RTCPeerConnection          â”‚
     â”‚  â”‚ pc.addTrack(ë‚´ ë¯¸ë””ì–´)          â”‚           â”‚                                              â”‚  â”‚ pc.addTrack(ë‚´ ë¯¸ë””ì–´)          â”‚
     â”‚  â”‚ pc.ontrack = (ìƒëŒ€ ë¯¸ë””ì–´ ìˆ˜ì‹ ) â”‚           â”‚                                              â”‚  â”‚ pc.ontrack = (ìƒëŒ€ ë¯¸ë””ì–´ ìˆ˜ì‹ ) â”‚
     â”‚  â”‚ pc.setRemoteDescription(offer) â”‚           â”‚                                              â”‚  â”‚ pc.setRemoteDescription(offer) â”‚
     â”‚  â”‚ answer = createAnswer()        â”‚           â”‚                                              â”‚  â”‚ answer = createAnswer()        â”‚
     â”‚  â”‚ pc.setLocalDescription(answer) â”‚           â”‚                                              â”‚  â”‚ pc.setLocalDescription(answer) â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  emit('answer', { target: 'A', answer })     â”‚                                              â”‚  emit('answer', { target: 'B', answer })
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                              â”‚                                              â”‚                              â”‚
     â”‚                                              â”‚  7. emit('answer', { from: 'B', answer })    â”‚                              â”‚
     â”‚                                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
     â”‚                                              â”‚                                              â”‚                              â”‚
     â”‚                                              â”‚  7. emit('answer', { from: 'A', answer })    â”‚                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                              â”‚                                              â”‚
     â”‚  8. on('answer') - Aì˜ answer ìˆ˜ì‹             â”‚                                              â”‚  8. on('answer') - Bì˜ answer ìˆ˜ì‹ 
     â”‚  pc.setRemoteDescription(answer)             â”‚                                              â”‚  pc.setRemoteDescription(answer)
     â”‚                                              â”‚                                              â”‚
```

**í•µì‹¬ í¬ì¸íŠ¸:**
1. **Offer ìˆ˜ì‹ ìê°€ Answerë¥¼ ìƒì„±**
2. `setRemoteDescription(offer)`: ìƒëŒ€ë°©ì˜ ë¯¸ë””ì–´ ìŠ¤í™ ì €ì¥
3. `setLocalDescription(answer)`: ë‚´ ì‘ë‹µ í™•ì •

---

#### Phase 5: ICE Candidate êµí™˜ (ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ íƒìƒ‰)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B í´ë¼  â”‚                                    â”‚  ì„œë²„   â”‚                                    â”‚ A í´ë¼  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                              â”‚                                              â”‚
     â”‚  9. pc.onicecandidate ìë™ ë°œìƒ               â”‚                                              â”‚  9. pc.onicecandidate ìë™ ë°œìƒ
     â”‚  (ë¸Œë¼ìš°ì €ê°€ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ íƒìƒ‰)                 â”‚                                              â”‚  (ë¸Œë¼ìš°ì €ê°€ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ íƒìƒ‰)
     â”‚                                              â”‚                                              â”‚
     â”‚  candidate = {                               â”‚                                              â”‚  candidate = {
     â”‚    candidate: "192.168.0.10:54321",          â”‚                                              â”‚    candidate: "192.168.0.20:12345",
     â”‚    sdpMid: "0",                              â”‚                                              â”‚    sdpMid: "0",
     â”‚    sdpMLineIndex: 0                          â”‚                                              â”‚    sdpMLineIndex: 0
     â”‚  }                                           â”‚                                              â”‚  }
     â”‚                                              â”‚                                              â”‚
     â”‚  emit('ice-candidate',                       â”‚                                              â”‚  emit('ice-candidate',
     â”‚    { target: 'A', candidate })               â”‚                                              â”‚    { target: 'B', candidate })
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                              â”‚                                              â”‚
     â”‚                                              â”‚  10. ì–‘ë°©í–¥ ì¤‘ê³„                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                              â”‚                                              â”‚
     â”‚  pc.addIceCandidate(Aì˜ candidate)           â”‚                                              â”‚  pc.addIceCandidate(Bì˜ candidate)
     â”‚                                              â”‚                                              â”‚
     â”‚  ğŸ”— ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ í™•ë¦½!                        â”‚                                              â”‚  ğŸ”— ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ í™•ë¦½!
     â”‚                                              â”‚                                              â”‚
```

**ICE Candidateë€?**
- **Interactive Connectivity Establishment**ì˜ ì•½ì
- ë‚´ ì¥ì¹˜ê°€ ì™¸ë¶€ì™€ í†µì‹ í•  ìˆ˜ ìˆëŠ” **ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ í›„ë³´**
- ì¢…ë¥˜:
  - **host**: ë‚´ ë¡œì»¬ IP (192.168.x.x)
  - **srflx**: STUN ì„œë²„ê°€ ë°œê²¬í•œ ê³µì¸ IP
  - **relay**: TURN ì„œë²„ë¥¼ í†µí•œ ì¤‘ê³„ ê²½ë¡œ (NAT í†µê³¼ ì‹¤íŒ¨ ì‹œ)

**ì™œ ì—¬ëŸ¬ ê°œê°€ ë°œìƒí•˜ë‚˜ìš”?**
- ë¸Œë¼ìš°ì €ëŠ” ê°€ëŠ¥í•œ ëª¨ë“  ê²½ë¡œë¥¼ íƒìƒ‰
- ê°€ì¥ ë¹ ë¥¸ ê²½ë¡œê°€ ìë™ ì„ íƒë¨

---

#### Phase 6: P2P ì—°ê²° ì™„ë£Œ ë° ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì „ì†¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B í´ë¼  â”‚                                                                  â”‚ A í´ë¼  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                                            â”‚
     â”‚  11. pc.ontrack ì´ë²¤íŠ¸ ë°œìƒ!                                               â”‚  11. pc.ontrack ì´ë²¤íŠ¸ ë°œìƒ!
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚ event.track.kind = 'video'   â”‚                                         â”‚  â”‚ event.track.kind = 'video'   â”‚
     â”‚  â”‚ event.streams[0] = Aì˜ ìŠ¤íŠ¸ë¦¼  â”‚                                         â”‚  â”‚ event.streams[0] = Bì˜ ìŠ¤íŠ¸ë¦¼  â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                                            â”‚
     â”‚  setRemoteStreams(prev => prev.set('A', stream))                          â”‚  setRemoteStreams(prev => prev.set('B', stream))
     â”‚                                                                            â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚ event.track.kind = 'audio'   â”‚                                         â”‚  â”‚ event.track.kind = 'audio'   â”‚
     â”‚  â”‚ event.streams[0] = Aì˜ ìŠ¤íŠ¸ë¦¼  â”‚                                         â”‚  â”‚ event.streams[0] = Bì˜ ìŠ¤íŠ¸ë¦¼  â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                                            â”‚
     â”‚                                                                            â”‚
     â”‚  âœ… Aì˜ í™”ë©´ í‘œì‹œ!                                                           â”‚  âœ… Bì˜ í™”ë©´ í‘œì‹œ!
     â”‚                                                                            â”‚
     â”‚ â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• P2P ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º â”‚
     â”‚              (ì„œë²„ë¥¼ ê±°ì¹˜ì§€ ì•ŠëŠ” ì§ì ‘ ì „ì†¡!)                                   â”‚
     â”‚                                                                            â”‚
```

**ontrack ì´ë²¤íŠ¸ í•µì‹¬:**
- **íŠ¸ë™ë³„ë¡œ ë°œë™**: video 1íšŒ, audio 1íšŒ (ì´ 2íšŒ)
- `event.streams[0]`: ìƒëŒ€ë°©ì˜ MediaStream ê°ì²´
- ì´ ìŠ¤íŠ¸ë¦¼ì„ `<video>` íƒœê·¸ì˜ `srcObject`ì— ì—°ê²°í•˜ë©´ í™”ë©´ ì¶œë ¥!

---

### 3.2 íƒ€ì„ë¼ì¸ ìš”ì•½

| ì‹œê°„ | A (ë°© ìƒì„±ì) | B (ì°¸ì—¬ì) | ì„œë²„ |
|------|--------------|-----------|------|
| T0 | `createRoom()` | - | ë°© ìƒì„±, A ì¶”ê°€ |
| T1 | ëŒ€ê¸° ì¤‘ | `joinRoom()` | B ì¶”ê°€, `existingUsers` ì‘ë‹µ |
| T2 | `user-joined` ìˆ˜ì‹  | `existingUsers` íšë“ | - |
| T3 | `sendOffer('B')` | `sendOffer('A')` | ì–‘ë°©í–¥ offer ì¤‘ê³„ |
| T4 | `handleOffer()` | `handleOffer()` | - |
| T5 | `createAnswer()` | `createAnswer()` | ì–‘ë°©í–¥ answer ì¤‘ê³„ |
| T6 | ICE íƒìƒ‰ ì‹œì‘ | ICE íƒìƒ‰ ì‹œì‘ | ICE candidate ì¤‘ê³„ |
| T7 | `ontrack` ë°œìƒ | `ontrack` ë°œìƒ | - |
| T8 | âœ… P2P ì—°ê²° ì™„ë£Œ | âœ… P2P ì—°ê²° ì™„ë£Œ | - |

---

## 4. ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œ

### 4.1 ë°±ì—”ë“œ: ì‹œê·¸ë„ë§ ì„œë²„ (server.js)

#### í•µì‹¬ ë°ì´í„° êµ¬ì¡°

```javascript
// ë°© ê´€ë¦¬ (In-memory, ì‹¤ì œë¡œëŠ” Redisë‚˜ DB ì‚¬ìš© ê¶Œì¥)
const rooms = new Map()

// êµ¬ì¡°:
// Map<roomId, Room>
// Room = {
//   id: string,
//   users: Set<socketId>,  // Setì„ ì‚¬ìš©í•´ ì¤‘ë³µ ë°©ì§€
//   createdAt: string
// }
```

#### ë°© ìƒì„± ì´ë²¤íŠ¸

```javascript
socket.on('create-room', (roomId, callback) => {
  try {
    // 1ï¸âƒ£ ìœ íš¨ì„± ê²€ì¦
    validateRoomId(roomId)
    if (rooms.has(roomId)) throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°©')

    // 2ï¸âƒ£ ë°© ìƒì„±
    rooms.set(roomId, {
      id: roomId,
      users: new Set([socket.id]),  // ìƒì„±ì ë°”ë¡œ ì¶”ê°€
      createdAt: new Date().toISOString()
    })

    // 3ï¸âƒ£ ì†Œì¼“ ë£¸ ì°¸ì—¬
    socket.join(roomId)
    socket.currentRoom = roomId  // í˜„ì¬ ë°© ì •ë³´ ì €ì¥

    // 4ï¸âƒ£ ìƒì„±ìì—ê²Œë§Œ ì‘ë‹µ (callback)
    callback({ success: true, roomId })

    // âš ï¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì—†ìŒ (ë³¸ì¸ë§Œ ìˆìœ¼ë‹ˆê¹Œ)
  } catch (error) {
    callback({ success: false, error: error.message })
  }
})
```

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] ë°© ìƒì„± ê¶Œí•œ ê²€ì¦ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
- [ ] ë°© ìµœëŒ€ ì¸ì› ì œí•œ
- [ ] ë°© ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
- [ ] DB ì €ì¥ (ì˜êµ¬ ì €ì¥)

---

#### ë°© ì…ì¥ ì´ë²¤íŠ¸

```javascript
socket.on('join-room', (roomId, callback) => {
  try {
    // 1ï¸âƒ£ ìœ íš¨ì„± ê²€ì¦
    validateRoomId(roomId)
    if (!rooms.has(roomId)) throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©')

    const room = rooms.get(roomId)

    // 2ï¸âƒ£ ê¸°ì¡´ ì°¸ì—¬ì ëª©ë¡ (ë³¸ì¸ ì œì™¸)
    const existingUsers = Array.from(room.users)

    // 3ï¸âƒ£ ë°© ì…ì¥ ì²˜ë¦¬
    socket.join(roomId)
    socket.currentRoom = roomId
    room.users.add(socket.id)  // Setì— ì¶”ê°€

    // 4ï¸âƒ£ ê¸°ì¡´ ì°¸ì—¬ìë“¤ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    socket.to(roomId).emit('user-joined', {
      userId: socket.id,
      timestamp: new Date().toISOString()
    })

    // 5ï¸âƒ£ ìš”ì²­ìì—ê²Œ ì½œë°± (ê¸°ì¡´ ì°¸ì—¬ì ëª©ë¡ í¬í•¨!)
    callback({
      success: true,
      roomId,
      existingUsers  // ğŸ”‘ ì´ê±¸ ë°›ì•„ì„œ offer ì „ì†¡!
    })
  } catch (error) {
    callback({ success: false, error: error.message })
  }
})
```

**íŒ¨í„´ ë¶„ì„:**
- **Callback**: ìš”ì²­ì(B)ì—ê²Œë§Œ `existingUsers` ì „ë‹¬
- **Broadcast**: ê¸°ì¡´ ì°¸ì—¬ì(A)ë“¤ì—ê²Œ `user-joined` ì•Œë¦¼

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] ë°© ì¸ì› ì œí•œ ì²´í¬
- [ ] ì…ì¥ ê¶Œí•œ ê²€ì¦ (ì´ˆëŒ€ ë§í¬, ë¹„ë°€ë²ˆí˜¸)
- [ ] ì…ì¥ ì‹œ ê¸°ì¡´ ì°¸ì—¬ì ì •ë³´ ì „ì†¡ (ë‹‰ë„¤ì„, í”„ë¡œí•„ ë“±)

---

#### Offer/Answer/ICE ì¤‘ê³„

```javascript
// 1. Offer ì¤‘ê³„ (1:1 ì‹œê·¸ë„ë§)
socket.on('offer', (data) => {
  try {
    // ê²€ì¦
    if (!data?.target || !data?.offer) throw new Error('Invalid offer')
    validateSdpSize(data.offer, 'Offer')  // DoS ë°©ì§€

    console.log(`[Offer] ${socket.id} â†’ ${data.target}`)

    // íŠ¹ì • ëŒ€ìƒì—ê²Œë§Œ ì „ë‹¬ (1:1)
    socket.to(data.target).emit('offer', {
      offer: data.offer,
      from: socket.id  // ğŸ”‘ ë°œì‹ ì ì •ë³´ í¬í•¨!
    })
  } catch (error) {
    socket.emit('error', { type: 'offer-error', message: error.message })
  }
})

// 2. Answer ì¤‘ê³„ (1:1 ì‹œê·¸ë„ë§)
socket.on('answer', (data) => {
  try {
    if (!data?.target || !data?.answer) throw new Error('Invalid answer')
    validateSdpSize(data.answer, 'Answer')

    console.log(`[Answer] ${socket.id} â†’ ${data.target}`)

    socket.to(data.target).emit('answer', {
      answer: data.answer,
      from: socket.id
    })
  } catch (error) {
    socket.emit('error', { type: 'answer-error', message: error.message })
  }
})

// 3. ICE Candidate ì¤‘ê³„
socket.on('ice-candidate', (data) => {
  try {
    if (!data?.target || !data?.candidate) throw new Error('Invalid ICE')

    console.log(`[ICE] ${socket.id} â†’ ${data.target}`)

    socket.to(data.target).emit('ice-candidate', {
      candidate: data.candidate,
      from: socket.id
    })
  } catch (error) {
    socket.emit('error', { type: 'ice-error', message: error.message })
  }
})
```

**í•µì‹¬ ì›ì¹™:**
- ì„œë²„ëŠ” **ë‹¨ìˆœ ì¤‘ê³„ì** ì—­í• 
- SDP ë°ì´í„°ì˜ ë‚´ìš©ì„ íŒŒì‹±í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
- `from` í•„ë“œë¥¼ ì¶”ê°€í•´ì„œ ë°œì‹ ì ì‹ë³„

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] ì‹œê·¸ë„ë§ ë©”ì‹œì§€ ë¡œê¹… (ë””ë²„ê¹…ìš©)
- [ ] ëŒ€ì—­í­ ì œí•œ (rate limiting)
- [ ] ë©”ì‹œì§€ ì•”í˜¸í™”

---

#### ì—°ê²° í•´ì œ ì²˜ë¦¬

```javascript
// ë°© ë‚˜ê°€ê¸° ê³µí†µ ë¡œì§
function leaveCurrentRoom(socket) {
  if (!socket.currentRoom) return

  const room = rooms.get(socket.currentRoom)
  if (!room) return

  // 1ï¸âƒ£ ë°©ì—ì„œ ì‚¬ìš©ì ì œê±°
  room.users.delete(socket.id)

  console.log(`[ë°© í‡´ì¥] ${socket.id} â† ${socket.currentRoom} (ë‚¨ì€: ${room.users.size}ëª…)`)

  // 2ï¸âƒ£ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì—ê²Œ ì•Œë¦¼
  socket.to(socket.currentRoom).emit('user-left', {
    userId: socket.id,
    timestamp: new Date().toISOString()
  })

  // 3ï¸âƒ£ ë°©ì´ ë¹„ì—ˆìœ¼ë©´ ì‚­ì œ
  if (room.users.size === 0) {
    rooms.delete(socket.currentRoom)
    console.log(`[ë°© ì‚­ì œ] ${socket.currentRoom} (ë¹„ì–´ìˆìŒ)`)
  }

  socket.leave(socket.currentRoom)
  socket.currentRoom = null
}

// ëª…ì‹œì  í‡´ì¥
socket.on('leave-room', () => {
  leaveCurrentRoom(socket)
})

// ì—°ê²° í•´ì œ (ë¸Œë¼ìš°ì € ì¢…ë£Œ, ë„¤íŠ¸ì›Œí¬ ëŠê¹€ ë“±)
socket.on('disconnect', (reason) => {
  console.log(`[ì—°ê²° í•´ì œ] ${socket.id} (ì´ìœ : ${reason})`)
  leaveCurrentRoom(socket)
})
```

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] í˜¸ìŠ¤íŠ¸ í‡´ì¥ ì‹œ ë°© ì‚­ì œ or í˜¸ìŠ¤íŠ¸ ìœ„ì„
- [ ] í‡´ì¥ ì „ í™•ì¸ ë©”ì‹œì§€
- [ ] í‡´ì¥ ì‚¬ìœ  ê¸°ë¡

---

### 4.2 í”„ë¡ íŠ¸ì—”ë“œ: í›… êµ¬í˜„

#### 4.2.1 useSocket (ì‹±ê¸€í†¤ íŒ¨í„´)

**ì™œ ì‹±ê¸€í†¤ì¸ê°€?**
- ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê°™ì€ ì†Œì¼“ì„ ê³µìœ 
- ì¤‘ë³µ ì—°ê²° ë°©ì§€ (ë¹„ìš© ì ˆê°)
- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€

```typescript
// ğŸ“ frontend/src/hooks/useSocket.ts

import { useEffect, useRef, useState } from "react"
import { io, Socket } from "socket.io-client"

// ===== ëª¨ë“ˆ ë ˆë²¨ ë³€ìˆ˜ (ì•± ì „ì²´ì—ì„œ ê³µìœ ) =====
let socketInstance: Socket | null = null
let connectionCount = 0

const useSocket = () => {
  const socket = useRef<Socket | null>(null)
  const [isConnected, setIsConnected] = useState(false)

  useEffect(() => {
    // 1ï¸âƒ£ ì‹±ê¸€í†¤: ìµœì´ˆ 1íšŒë§Œ ìƒì„±
    if (!socketInstance) {
      console.log('ğŸ”Œ ìƒˆ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±')

      socketInstance = io('http://localhost:3000', {
        reconnection: true,          // ìë™ ì¬ì—°ê²°
        reconnectionDelay: 1000,     // 1ì´ˆ í›„ ì¬ì‹œë„
        reconnectionAttempts: 5,     // ìµœëŒ€ 5íšŒ ì‹œë„
      })

      // 2ï¸âƒ£ ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ë“±ë¡)
      socketInstance.on('connect', () => {
        console.log('âœ… ì†Œì¼“ ì—°ê²° ì™„ë£Œ:', socketInstance?.id)
      })

      socketInstance.on('disconnect', (reason) => {
        console.log('âŒ ì†Œì¼“ ì—°ê²° í•´ì œ:', reason)
      })

      socketInstance.on('connect_error', (error) => {
        console.error('âš ï¸ ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨:', error.message)
      })
    }

    // 3ï¸âƒ£ í˜„ì¬ ì»´í¬ë„ŒíŠ¸ì— ì‹±ê¸€í†¤ í• ë‹¹
    socket.current = socketInstance
    connectionCount++
    console.log(`ğŸ“Š ì†Œì¼“ ì‚¬ìš© ì¤‘ì¸ ì»´í¬ë„ŒíŠ¸: ${connectionCount}ê°œ`)

    // 4ï¸âƒ£ ì»´í¬ë„ŒíŠ¸ë³„ ìƒíƒœ ë™ê¸°í™”
    setIsConnected(socketInstance.connected)

    const handleConnect = () => setIsConnected(true)
    const handleDisconnect = () => setIsConnected(false)

    socketInstance.on('connect', handleConnect)
    socketInstance.on('disconnect', handleDisconnect)

    // 5ï¸âƒ£ Cleanup
    return () => {
      connectionCount--
      console.log(`ğŸ“Š ì†Œì¼“ ì‚¬ìš© ì¤‘ì¸ ì»´í¬ë„ŒíŠ¸: ${connectionCount}ê°œ`)

      socketInstance?.off('connect', handleConnect)
      socketInstance?.off('disconnect', handleDisconnect)

      // ë§ˆì§€ë§‰ ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ë˜ë©´ ì†Œì¼“ ì¢…ë£Œ
      if (connectionCount === 0 && socketInstance) {
        console.log('ğŸ”Œ ì†Œì¼“ ì™„ì „ ì¢…ë£Œ')
        socketInstance.close()
        socketInstance = null
      }

      socket.current = null
    }
  }, [])

  return { socket, isConnected }
}

export default useSocket
```

**ë™ì‘ ì›ë¦¬:**

```
ì»´í¬ë„ŒíŠ¸ A ë§ˆìš´íŠ¸ â†’ socketInstance ìƒì„± â†’ connectionCount = 1
ì»´í¬ë„ŒíŠ¸ B ë§ˆìš´íŠ¸ â†’ ê¸°ì¡´ instance ì¬ì‚¬ìš© â†’ connectionCount = 2
ì»´í¬ë„ŒíŠ¸ A ì–¸ë§ˆìš´íŠ¸ â†’ connectionCount = 1 (ìœ ì§€)
ì»´í¬ë„ŒíŠ¸ B ì–¸ë§ˆìš´íŠ¸ â†’ connectionCount = 0 â†’ ì†Œì¼“ ì¢…ë£Œ!
```

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] í™˜ê²½ë³€ìˆ˜ë¡œ ì„œë²„ URL ê´€ë¦¬
- [ ] í† í° ê¸°ë°˜ ì¸ì¦ (auth ì˜µì…˜)
- [ ] ì—°ê²° ìƒíƒœì— ë”°ë¥¸ UI í”¼ë“œë°±

---

#### 4.2.2 useLocalStream (ë¯¸ë””ì–´ ì œì–´)

```typescript
// ğŸ“ frontend/src/features/video-chat/hooks/useLocalStream.ts

import { useEffect, useRef, useState } from "react"

const useLocalStream = () => {
  const [localStream, setLocalStream] = useState<MediaStream | null>(null)
  const [isVideoEnabled, setIsVideoEnabled] = useState(true)
  const [isAudioEnabled, setIsAudioEnabled] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(false)

  const streamRef = useRef<MediaStream | null>(null)

  // ì¹´ë©”ë¼/ë§ˆì´í¬ ì‹œì‘
  const startMedia = async (constraints?: MediaStreamConstraints) => {
    setIsLoading(true)
    setError(null)

    try {
      const stream = await navigator.mediaDevices.getUserMedia(
        constraints || {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'  // ì „ë©´ ì¹´ë©”ë¼
          },
          audio: {
            echoCancellation: true,   // ì—ì½” ì œê±°
            noiseSuppression: true,   // ì†ŒìŒ ì–µì œ
            autoGainControl: true     // ìë™ ë³¼ë¥¨ ì¡°ì ˆ
          }
        }
      )

      streamRef.current = stream
      setLocalStream(stream)
      setIsVideoEnabled(true)
      setIsAudioEnabled(true)

      console.log('ğŸ“¹ ë¯¸ë””ì–´ ì‹œì‘')
      console.log('ë¹„ë””ì˜¤ íŠ¸ë™:', stream.getVideoTracks().length)
      console.log('ì˜¤ë””ì˜¤ íŠ¸ë™:', stream.getAudioTracks().length)

      return stream
    } catch (err) {
      // ì—ëŸ¬ íƒ€ì…ë³„ ë©”ì‹œì§€
      let errorMessage = 'ë¯¸ë””ì–´ ì ‘ê·¼ ì‹¤íŒ¨'

      if (err instanceof Error) {
        if (err.name === 'NotAllowedError') {
          errorMessage = 'ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤'
        } else if (err.name === 'NotFoundError') {
          errorMessage = 'ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
        } else if (err.name === 'NotReadableError') {
          errorMessage = 'ì¹´ë©”ë¼/ë§ˆì´í¬ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤'
        }
      }

      setError(errorMessage)
      throw err
    } finally {
      setIsLoading(false)
    }
  }

  // ë¯¸ë””ì–´ ì •ì§€
  const stopMedia = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => {
        track.stop()
        console.log(`ğŸ›‘ ${track.kind} íŠ¸ë™ ì •ì§€`)
      })

      streamRef.current = null
      setLocalStream(null)
      setIsVideoEnabled(false)
      setIsAudioEnabled(false)
    }
  }

  // ë¹„ë””ì˜¤ í† ê¸€ (íŠ¸ë™ enable/disable)
  const toggleVideo = () => {
    if (localStream) {
      const videoTrack = localStream.getVideoTracks()[0]
      if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled
        setIsVideoEnabled(videoTrack.enabled)
        console.log(`ğŸ“¹ ë¹„ë””ì˜¤: ${videoTrack.enabled ? 'ON' : 'OFF'}`)
      }
    }
  }

  // ì˜¤ë””ì˜¤ í† ê¸€
  const toggleAudio = () => {
    if (localStream) {
      const audioTrack = localStream.getAudioTracks()[0]
      if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled
        setIsAudioEnabled(audioTrack.enabled)
        console.log(`ğŸ¤ ì˜¤ë””ì˜¤: ${audioTrack.enabled ? 'ON' : 'OFF'}`)
      }
    }
  }

  // ì¹´ë©”ë¼ ì „í™˜ (ëª¨ë°”ì¼ìš©)
  const switchCamera = async () => {
    if (!localStream) return

    const videoTrack = localStream.getVideoTracks()[0]
    if (!videoTrack) return

    const settings = videoTrack.getSettings()
    const currentFacingMode = settings.facingMode || 'user'
    const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'

    try {
      stopMedia()
      await startMedia({
        video: { facingMode: newFacingMode },
        audio: true
      })
      console.log(`ğŸ“¹ ì¹´ë©”ë¼ ì „í™˜: ${newFacingMode}`)
    } catch (err) {
      console.error('âŒ ì¹´ë©”ë¼ ì „í™˜ ì‹¤íŒ¨:', err)
    }
  }

  // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
  useEffect(() => {
    return () => {
      if (streamRef.current) {
        streamRef.current.getTracks().forEach(track => track.stop())
        console.log('ğŸ§¹ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬')
      }
    }
  }, [])

  return {
    localStream,
    isVideoEnabled,
    isAudioEnabled,
    error,
    isLoading,
    startMedia,
    stopMedia,
    toggleVideo,
    toggleAudio,
    switchCamera
  }
}

export default useLocalStream
```

**track.enabled vs track.stop():**
- `enabled = false`: íŠ¸ë™ ë¹„í™œì„±í™” (ë‹¤ì‹œ ì¼¤ ìˆ˜ ìˆìŒ) â†’ í† ê¸€ìš©
- `stop()`: íŠ¸ë™ ì™„ì „ ì¢…ë£Œ (ë‹¤ì‹œ ëª» ì¼¬) â†’ ì •ë¦¬ìš©

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] í™”ë©´ ê³µìœ  ê¸°ëŠ¥ (`getDisplayMedia`)
- [ ] í•´ìƒë„ ë³€ê²½
- [ ] ë°°ê²½ blur íš¨ê³¼
- [ ] ê°€ìƒ ë°°ê²½

---

#### 4.2.3 useWebRTC (P2P ì—°ê²° ê´€ë¦¬)

ì´ í›…ì´ ê°€ì¥ ë³µì¡í•˜ê³  ì¤‘ìš”í•©ë‹ˆë‹¤!

```typescript
// ğŸ“ frontend/src/features/video-chat/hooks/useWebRTC.ts

import useSocket from "@/hooks/useSocket"
import { useEffect, useRef, useState } from "react"

interface OfferData {
  offer: RTCSessionDescriptionInit
  from: string
}

interface AnswerData {
  answer: RTCSessionDescriptionInit
  from: string
}

interface IceCandidateData {
  candidate: RTCIceCandidateInit
  from: string
}

// STUN ì„œë²„ ì„¤ì • (Google ê³µê°œ STUN)
const configuration = {
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
}

const useWebRTC = (localStream: MediaStream | null) => {
  // ì‚¬ìš©ìë³„ PeerConnection ê´€ë¦¬
  const peerConnections = useRef<Map<string, RTCPeerConnection>>(new Map())

  // ì›ê²© ìŠ¤íŠ¸ë¦¼ ì €ì¥ì†Œ
  const [remoteStreams, setRemoteStreams] = useState<Map<string, MediaStream>>(new Map())

  const { socket } = useSocket()

  useEffect(() => {
    if (!socket.current) return

    const currentSocket = socket.current
    const currentPeerConnections = peerConnections.current

    // ========================================
    // 1ï¸âƒ£ Offer ìˆ˜ì‹  í•¸ë“¤ëŸ¬
    // ========================================
    const handleOffer = async (data: OfferData) => {
      if (!socket.current) return

      try {
        console.log(`ğŸ“¥ Offer ìˆ˜ì‹  from ${data.from}`)

        // A. PeerConnection ìƒì„±
        const pc = new RTCPeerConnection(configuration)
        peerConnections.current.set(data.from, pc)

        // B. ë‚´ ë¯¸ë””ì–´ íŠ¸ë™ ì¶”ê°€
        if (localStream) {
          localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream)
          })
        }

        // C. ìƒëŒ€ë°© ë¯¸ë””ì–´ ìˆ˜ì‹  í•¸ë“¤ëŸ¬
        pc.ontrack = (event) => {
          console.log(`ğŸ“¥ íŠ¸ë™ ìˆ˜ì‹ : ${event.track.kind} from ${data.from}`)
          setRemoteStreams(prev => new Map(prev).set(data.from, event.streams[0]))
        }

        // D. ICE Candidate í•¸ë“¤ëŸ¬
        pc.onicecandidate = (event) => {
          if (event.candidate && socket.current) {
            socket.current.emit('ice-candidate', {
              target: data.from,
              candidate: event.candidate
            })
          }
        }

        // E. ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
        pc.onconnectionstatechange = () => {
          console.log(`ğŸ”Œ [${data.from}] ì—°ê²° ìƒíƒœ:`, pc.connectionState)

          if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
            peerConnections.current.delete(data.from)
            pc.close()
          }
        }

        // F. Offer ì²˜ë¦¬ ë° Answer ìƒì„±
        await pc.setRemoteDescription(data.offer)
        const answer = await pc.createAnswer()
        await pc.setLocalDescription(answer)

        // G. Answer ì „ì†¡
        socket.current.emit('answer', {
          target: data.from,
          answer
        })

        console.log(`ğŸ“¤ Answer ì „ì†¡ to ${data.from}`)
      } catch (error) {
        console.error('âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨:', error)
      }
    }

    // ========================================
    // 2ï¸âƒ£ Answer ìˆ˜ì‹  í•¸ë“¤ëŸ¬
    // ========================================
    const handleAnswer = async (data: AnswerData) => {
      try {
        console.log(`ğŸ“¥ Answer ìˆ˜ì‹  from ${data.from}`)

        const pc = peerConnections.current.get(data.from)
        if (!pc) {
          console.error(`âŒ PeerConnectionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${data.from}`)
          return
        }

        await pc.setRemoteDescription(data.answer)
        console.log(`âœ… Answer ì„¤ì • ì™„ë£Œ: ${data.from}`)
      } catch (error) {
        console.error('âŒ Answer ì²˜ë¦¬ ì‹¤íŒ¨:', error)
      }
    }

    // ========================================
    // 3ï¸âƒ£ ICE Candidate ìˆ˜ì‹  í•¸ë“¤ëŸ¬
    // ========================================
    const handleIceCandidate = async (data: IceCandidateData) => {
      try {
        console.log(`ğŸ“¥ ICE Candidate ìˆ˜ì‹  from ${data.from}`)

        const pc = peerConnections.current.get(data.from)
        if (!pc) {
          console.error(`âŒ PeerConnectionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${data.from}`)
          return
        }

        await pc.addIceCandidate(data.candidate)
      } catch (error) {
        console.error('âŒ ICE Candidate ì¶”ê°€ ì‹¤íŒ¨:', error)
      }
    }

    // ========================================
    // 4ï¸âƒ£ ì‚¬ìš©ì í‡´ì¥ í•¸ë“¤ëŸ¬
    // ========================================
    const handleUserLeft = (data: { userId: string }) => {
      console.log(`ğŸ‘‹ ì‚¬ìš©ì í‡´ì¥: ${data.userId}`)

      const pc = peerConnections.current.get(data.userId)
      if (pc) {
        pc.close()
        peerConnections.current.delete(data.userId)
      }

      // ì›ê²© ìŠ¤íŠ¸ë¦¼ì—ì„œ ì œê±°
      setRemoteStreams(prev => {
        const newMap = new Map(prev)
        newMap.delete(data.userId)
        return newMap
      })
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    socket.current.on('offer', handleOffer)
    socket.current.on('answer', handleAnswer)
    socket.current.on('ice-candidate', handleIceCandidate)
    socket.current.on('user-left', handleUserLeft)

    // Cleanup
    return () => {
      currentSocket.off('offer', handleOffer)
      currentSocket.off('answer', handleAnswer)
      currentSocket.off('ice-candidate', handleIceCandidate)
      currentSocket.off('user-left', handleUserLeft)

      // ëª¨ë“  PeerConnection ì¢…ë£Œ
      currentPeerConnections.forEach(pc => pc.close())
      currentPeerConnections.clear()
    }
  }, [socket, localStream])

  // ========================================
  // Offer ì „ì†¡ í•¨ìˆ˜ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ)
  // ========================================
  const sendOffer = async (targetUserId: string) => {
    if (!socket.current) {
      console.error('âŒ Socketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
      return
    }

    try {
      // A. PeerConnection ìƒì„±
      const pc = new RTCPeerConnection(configuration)

      // B. ë‚´ ë¯¸ë””ì–´ íŠ¸ë™ ì¶”ê°€
      if (localStream) {
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream)
          console.log(`ğŸ“¤ ${track.kind} íŠ¸ë™ ì¶”ê°€`)
        })
      }

      peerConnections.current.set(targetUserId, pc)

      // C. ìƒëŒ€ë°© ë¯¸ë””ì–´ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ (âš ï¸ ì¤‘ìš”: handleOfferì™€ ë™ì¼í•˜ê²Œ!)
      pc.ontrack = (event) => {
        console.log(`ğŸ“¥ íŠ¸ë™ ìˆ˜ì‹ : ${event.track.kind} from ${targetUserId}`)
        setRemoteStreams(prev => new Map(prev).set(targetUserId, event.streams[0]))
      }

      // D. ICE Candidate í•¸ë“¤ëŸ¬
      pc.onicecandidate = (event) => {
        if (event.candidate && socket.current) {
          socket.current.emit('ice-candidate', {
            target: targetUserId,
            candidate: event.candidate
          })
        }
      }

      // E. ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
      pc.onconnectionstatechange = () => {
        console.log(`ğŸ”Œ [${targetUserId}] ì—°ê²° ìƒíƒœ:`, pc.connectionState)

        if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
          peerConnections.current.delete(targetUserId)
          pc.close()
        }
      }

      // F. Offer ìƒì„± ë° ì „ì†¡
      const offer = await pc.createOffer()
      await pc.setLocalDescription(offer)

      socket.current.emit('offer', { target: targetUserId, offer })
      console.log(`ğŸ“¤ Offer ì „ì†¡ to ${targetUserId}`)
    } catch (error) {
      console.error('âŒ Offer ì „ì†¡ ì‹¤íŒ¨:', error)
    }
  }

  return {
    sendOffer,
    remoteStreams
  }
}

export default useWebRTC
```

**í•µì‹¬ ì´í•´:**

1. **PeerConnectionì€ 1:1 ê´€ê³„**
   - ì°¸ì—¬ìê°€ 3ëª…ì´ë©´ ê°ì 2ê°œì˜ PCë¥¼ ê°€ì§ (Mesh Topology)
   - `Map<userId, RTCPeerConnection>`ë¡œ ê´€ë¦¬

2. **ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” SDP êµí™˜ ì „ì— ë“±ë¡**
   - `pc.ontrack`ì„ `setRemoteDescription()` ì´ì „ì— ë“±ë¡í•´ì•¼ í•¨
   - ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ íŠ¸ë™ì„ ë†“ì¹  ìˆ˜ ìˆìŒ

3. **addTrack()ì˜ ë‘ ë²ˆì§¸ ì¸ì**
   - `pc.addTrack(track, stream)`: streamì€ íŠ¸ë™ì˜ ê·¸ë£¹ ID
   - ìˆ˜ì‹ ì¸¡ì—ì„œ `event.streams[0]`ë¡œ ì ‘ê·¼ ê°€ëŠ¥

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] TURN ì„œë²„ ì¶”ê°€ (NAT í†µê³¼ ì‹¤íŒ¨ ëŒ€ë¹„)
- [ ] DataChannel ì¶”ê°€ (ì±„íŒ… ë©”ì‹œì§€)
- [ ] í†µê³„ ëª¨ë‹ˆí„°ë§ (`getStats()`)
- [ ] ì—°ê²° í’ˆì§ˆì— ë”°ë¥¸ í•´ìƒë„ ì¡°ì ˆ

---

#### 4.2.4 useRoom (ë°© ê´€ë¦¬)

```typescript
// ğŸ“ frontend/src/hooks/useRoom.ts

import useSocket from "@/hooks/useSocket"
import { useEffect, useState } from "react"

interface CreateRoomResponse {
  success: boolean
  roomId?: string
  error?: string
}

interface JoinRoomResponse {
  success: boolean
  roomId?: string
  existingUsers?: string[]
  error?: string
}

interface UserJoinedData {
  userId: string
  timestamp: string
}

const useRoom = () => {
  const { socket, isConnected } = useSocket()

  const [roomId, setRoomId] = useState<string | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [existingUsers, setExistingUsers] = useState<string[]>([])
  const [newUser, setNewUser] = useState<string | null>(null)

  // ë°© ìƒì„±
  const createRoom = (newRoomId: string) => {
    if (!socket.current || !isConnected) {
      setError('ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')
      return
    }

    if (roomId) {
      setError('ì´ë¯¸ ë°©ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤')
      return
    }

    setIsLoading(true)
    setError(null)

    socket.current.emit('create-room', newRoomId, (res: CreateRoomResponse) => {
      setIsLoading(false)

      if (res.success && res.roomId) {
        setRoomId(res.roomId)
        console.log(`âœ… ë°© ìƒì„± ì„±ê³µ: ${res.roomId}`)
      } else {
        setError(res.error || 'ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
      }
    })
  }

  // ë°© ì…ì¥
  const joinRoom = (targetRoomId: string) => {
    if (!socket.current || !isConnected) {
      setError('ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')
      return
    }

    if (roomId) {
      setError('ì´ë¯¸ ë°©ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤')
      return
    }

    setIsLoading(true)
    setError(null)

    socket.current.emit('join-room', targetRoomId, (res: JoinRoomResponse) => {
      setIsLoading(false)

      if (res.success && res.roomId) {
        setRoomId(res.roomId)
        console.log(`âœ… ë°© ì°¸ì—¬ ì„±ê³µ: ${res.roomId}`)
        console.log(`ê¸°ì¡´ ì°¸ì—¬ì: ${res.existingUsers?.length || 0}ëª…`)

        // ğŸ”‘ ê¸°ì¡´ ì°¸ì—¬ì ëª©ë¡ ì €ì¥ (useVideoChatì—ì„œ ì‚¬ìš©)
        if (res.existingUsers && res.existingUsers.length > 0) {
          setExistingUsers(res.existingUsers)
        }
      } else {
        setError(res.error || 'ë°© ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
      }
    })
  }

  // ë°© ë‚˜ê°€ê¸°
  const leaveRoom = () => {
    if (!socket.current || !roomId) return

    socket.current.emit('leave-room')
    setRoomId(null)
    setError(null)
    setExistingUsers([])
    console.log('âœ… ë°© í‡´ì¥')
  }

  // user-joined ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  useEffect(() => {
    if (!socket.current) return

    const handleUserJoined = (data: UserJoinedData) => {
      console.log(`ğŸ‘¥ ìƒˆ ì‚¬ìš©ì ì…ì¥: ${data.userId}`)
      setNewUser(data.userId)  // ğŸ”‘ useVideoChatì—ì„œ ê°ì§€
    }

    socket.current.on('user-joined', handleUserJoined)

    return () => {
      socket.current?.off('user-joined', handleUserJoined)
    }
  }, [socket])

  return {
    roomId,
    error,
    isLoading,
    isConnected,
    existingUsers,  // ë°© ì…ì¥ ì‹œ ê¸°ì¡´ ì°¸ì—¬ì
    newUser,        // ìƒˆë¡œ ì…ì¥í•œ ì°¸ì—¬ì
    createRoom,
    joinRoom,
    leaveRoom
  }
}

export default useRoom
```

**ğŸ” í™•ì¥ í¬ì¸íŠ¸:**
- [ ] ë°© ëª©ë¡ ì¡°íšŒ
- [ ] ë°© ì •ë³´ í‘œì‹œ (ì°¸ì—¬ì ìˆ˜, ìƒì„± ì‹œê°„)
- [ ] ì´ˆëŒ€ ë§í¬ ìƒì„±

---

#### 4.2.5 useVideoChat (í†µí•© ë ˆì´ì–´)

```typescript
// ğŸ“ frontend/src/features/video-chat/hooks/useVideoChat.ts

import useLocalStream from "@/features/video-chat/hooks/useLocalStream"
import useWebRTC from "@/features/video-chat/hooks/useWebRTC"
import useRoom from "@/hooks/useRoom"
import { useEffect } from "react"

const useVideoChat = () => {
  // 1. ë¯¸ë””ì–´ ì œì–´
  const {
    localStream,
    isVideoEnabled,
    isAudioEnabled,
    error: socketError,
    isLoading: isSocketLoading,
    startMedia,
    stopMedia,
    toggleVideo,
    toggleAudio,
    switchCamera
  } = useLocalStream()

  // 2. P2P ì—°ê²°
  const {
    sendOffer,
    remoteStreams
  } = useWebRTC(localStream)

  // 3. ë°© ê´€ë¦¬
  const {
    roomId,
    error: roomError,
    isLoading: isRoomLoading,
    isConnected,
    existingUsers,
    newUser,
    createRoom,
    joinRoom,
    leaveRoom
  } = useRoom()

  // ========================================
  // ìë™ Offer ì „ì†¡ ë¡œì§
  // ========================================

  // ë°© ì…ì¥ ì‹œ: ê¸°ì¡´ ì°¸ì—¬ìë“¤ì—ê²Œ offer ì „ì†¡
  useEffect(() => {
    if (existingUsers.length > 0 && localStream) {
      console.log(`ğŸ“¤ ê¸°ì¡´ ì°¸ì—¬ì ${existingUsers.length}ëª…ì—ê²Œ Offer ì „ì†¡`)
      existingUsers.forEach(userId => {
        sendOffer(userId)
      })
    }
  }, [existingUsers, localStream, sendOffer])

  // ìƒˆ ì‚¬ìš©ì ì…ì¥ ì‹œ: ìƒˆ ì°¸ì—¬ìì—ê²Œ offer ì „ì†¡
  useEffect(() => {
    if (newUser && localStream) {
      console.log(`ğŸ“¤ ìƒˆ ì°¸ì—¬ì ${newUser}ì—ê²Œ Offer ì „ì†¡`)
      sendOffer(newUser)
    }
  }, [newUser, localStream, sendOffer])

  return {
    // ë¯¸ë””ì–´
    localStream,
    isVideoEnabled,
    isAudioEnabled,
    socketError,
    isSocketLoading,
    startMedia,
    stopMedia,
    toggleVideo,
    toggleAudio,
    switchCamera,

    // WebRTC
    remoteStreams,
    sendOffer,

    // ë°© ê´€ë¦¬
    roomId,
    error: roomError,
    isLoading: isRoomLoading,
    isConnected,
    createRoom,
    joinRoom,
    leaveRoom
  }
}

export default useVideoChat
```

**ì—­í• :**
- ê° í›…ì˜ ê¸°ëŠ¥ì„ í†µí•©
- ìë™ offer ì „ì†¡ ë¡œì§ (í•µì‹¬!)
- UIì— í•„ìš”í•œ ëª¨ë“  ìƒíƒœ/í•¨ìˆ˜ ì œê³µ

---

## 5. í•µì‹¬ ì´ë²¤íŠ¸ íƒ€ì´ë°

### 5.1 ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ìˆœì„œ

```typescript
// âš ï¸ ì˜¬ë°”ë¥¸ ìˆœì„œ
const pc = new RTCPeerConnection(configuration)

// 1ï¸âƒ£ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë¨¼ì € ë“±ë¡
pc.ontrack = (event) => { /* ... */ }
pc.onicecandidate = (event) => { /* ... */ }

// 2ï¸âƒ£ íŠ¸ë™ ì¶”ê°€
pc.addTrack(track, stream)

// 3ï¸âƒ£ SDP êµí™˜
await pc.setRemoteDescription(offer)
const answer = await pc.createAnswer()
await pc.setLocalDescription(answer)
```

**ì™œ ì´ ìˆœì„œê°€ ì¤‘ìš”í•œê°€?**
- `setRemoteDescription()` í˜¸ì¶œ ì¦‰ì‹œ `ontrack` ë°œìƒ ê°€ëŠ¥
- í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìœ¼ë©´ íŠ¸ë™ì„ ë†“ì¹¨!

---

### 5.2 React ì˜ì¡´ì„± ë°°ì—´ ì£¼ì˜ì‚¬í•­

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ: sendOffer ì¬ìƒì„±ìœ¼ë¡œ ë¬´í•œ ë£¨í”„
useEffect(() => {
  if (newUser && localStream) {
    sendOffer(newUser)
  }
}, [newUser, localStream, sendOffer])  // sendOfferê°€ ë§¤ë²ˆ ë°”ë€œ!

// âœ… í•´ê²° ë°©ë²• 1: useCallbackìœ¼ë¡œ sendOffer ë©”ëª¨ì´ì œì´ì…˜
const sendOffer = useCallback(async (targetUserId: string) => {
  // ...
}, [socket, localStream])

// âœ… í•´ê²° ë°©ë²• 2: eslint-disable (í˜„ì¬ êµ¬í˜„)
// eslint-disable-next-line react-hooks/exhaustive-deps
```

---

### 5.3 ìƒíƒœ ì—…ë°ì´íŠ¸ íƒ€ì´ë°

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ: ì´ì „ ìƒíƒœ ë¬´ì‹œ
setRemoteStreams(new Map().set(userId, stream))

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: ì´ì „ ìƒíƒœ ìœ ì§€
setRemoteStreams(prev => new Map(prev).set(userId, stream))
```

**ì´ìœ :**
- React ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ë¹„ë™ê¸°
- ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ì ‘ì†í•˜ë©´ ì´ì „ ìƒíƒœ ë®ì–´ì“°ê¸° ë°œìƒ

---

## 6. í™•ì¥ ê¸°ëŠ¥ êµ¬í˜„ í¬ì¸íŠ¸

### 6.1 ì‚¬ìš©ìë³„ ìŒí–¥ ì œì–´

**ìš”êµ¬ì‚¬í•­:** íŠ¹ì • ì°¸ì—¬ìì˜ ë³¼ë¥¨ ì¡°ì ˆ ë˜ëŠ” ìŒì†Œê±°

**êµ¬í˜„ ìœ„ì¹˜:** `VideoChat.tsx` - RemoteVideo ì»´í¬ë„ŒíŠ¸

```typescript
function RemoteVideo({ userId, stream }: { userId: string; stream: MediaStream }) {
  const videoRef = useRef<HTMLVideoElement>(null)
  const [volume, setVolume] = useState(1.0)  // 0.0 ~ 1.0
  const [isMuted, setIsMuted] = useState(false)

  useEffect(() => {
    if (videoRef.current && stream) {
      videoRef.current.srcObject = stream
      videoRef.current.volume = volume
      videoRef.current.muted = isMuted
    }
  }, [stream, volume, isMuted])

  return (
    <div>
      <video ref={videoRef} autoPlay playsInline />

      {/* ë³¼ë¥¨ ìŠ¬ë¼ì´ë” */}
      <input
        type="range"
        min="0"
        max="1"
        step="0.1"
        value={volume}
        onChange={(e) => setVolume(parseFloat(e.target.value))}
      />

      {/* ìŒì†Œê±° ë²„íŠ¼ */}
      <button onClick={() => setIsMuted(!isMuted)}>
        {isMuted ? 'ğŸ”‡' : 'ğŸ”Š'}
      </button>
    </div>
  )
}
```

**í•µì‹¬:**
- `<video>` íƒœê·¸ì˜ `volume`, `muted` ì†ì„± í™œìš©
- í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì œì–´ (ìƒëŒ€ë°©ì—ê²Œ ì˜í–¥ ì—†ìŒ)

---

### 6.2 í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ê´€ë¦¬

**ì‹œë‚˜ë¦¬ì˜¤:** ë°© ìƒì„±ìê°€ ë‚˜ê°€ë©´ ë°© ì‚­ì œ + ëª¨ë“  ì°¸ì—¬ì ê°•ì œ í‡´ì¥

#### ë°±ì—”ë“œ ìˆ˜ì •

```javascript
// server.js

// ë°© ìƒì„± ì‹œ í˜¸ìŠ¤íŠ¸ ì •ë³´ ì €ì¥
socket.on('create-room', (roomId, callback) => {
  rooms.set(roomId, {
    id: roomId,
    users: new Set([socket.id]),
    host: socket.id,  // ğŸ”‘ í˜¸ìŠ¤íŠ¸ ì¶”ê°€
    createdAt: new Date().toISOString()
  })
  // ...
})

// ì—°ê²° í•´ì œ ì‹œ í˜¸ìŠ¤íŠ¸ ì²´í¬
function leaveCurrentRoom(socket) {
  const room = rooms.get(socket.currentRoom)
  if (!room) return

  // ğŸ”‘ í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë©´ ë°© ì‚­ì œ
  if (room.host === socket.id) {
    console.log(`[í˜¸ìŠ¤íŠ¸ í‡´ì¥] ë°© ${socket.currentRoom} ì‚­ì œ`)

    // ëª¨ë“  ì°¸ì—¬ìì—ê²Œ ì•Œë¦¼
    io.to(socket.currentRoom).emit('room-closed', {
      reason: 'í˜¸ìŠ¤íŠ¸ê°€ í‡´ì¥í–ˆìŠµë‹ˆë‹¤'
    })

    rooms.delete(socket.currentRoom)
  } else {
    // ì¼ë°˜ ì°¸ì—¬ì í‡´ì¥ ì²˜ë¦¬
    room.users.delete(socket.id)
    socket.to(socket.currentRoom).emit('user-left', { userId: socket.id })
  }

  socket.leave(socket.currentRoom)
  socket.currentRoom = null
}
```

#### í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •

```typescript
// useRoom.ts

useEffect(() => {
  if (!socket.current) return

  const handleRoomClosed = (data: { reason: string }) => {
    console.log(`ğŸšª ë°© íì‡„: ${data.reason}`)
    setRoomId(null)
    setError(data.reason)
    // ì¶”ê°€: í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰ì…˜
    // navigate('/')
  }

  socket.current.on('room-closed', handleRoomClosed)

  return () => {
    socket.current?.off('room-closed', handleRoomClosed)
  }
}, [socket])
```

---

### 6.3 ë¦¬ë‹¤ì´ë ‰ì…˜ ì²˜ë¦¬

**ìš”êµ¬ì‚¬í•­:** ë°© ë‚˜ê°€ê¸° ì‹œ í™ˆìœ¼ë¡œ ì´ë™

**êµ¬í˜„ ìœ„ì¹˜:** `VideoChat.tsx`

```typescript
import { useNavigate } from 'react-router-dom'

export default function VideoChat() {
  const navigate = useNavigate()
  const { roomId, leaveRoom, ... } = useVideoChat()

  // roomIdê°€ nullì´ ë˜ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
  useEffect(() => {
    if (!roomId) {
      navigate('/')
    }
  }, [roomId, navigate])

  const handleLeaveRoom = () => {
    leaveRoom()
    // leaveRoom()ì´ setRoomId(null)ì„ í˜¸ì¶œí•˜ë©´ ìœ„ useEffectê°€ ë°œë™
  }

  return (
    // ...
    <button onClick={handleLeaveRoom}>ë°© ë‚˜ê°€ê¸°</button>
  )
}
```

---

### 6.4 ì—ëŸ¬ ì²˜ë¦¬ & UX ê°œì„ 

#### ë¡œë”© ìŠ¤í”¼ë„ˆ

```typescript
// VideoChat.tsx

const { isLoading, ... } = useVideoChat()

return (
  <div>
    {isLoading && (
      <div style={{ /* ì „ì²´ í™”ë©´ ì˜¤ë²„ë ˆì´ */ }}>
        <Spinner />
        <p>ì—°ê²° ì¤‘...</p>
      </div>
    )}
    {/* ë‚˜ë¨¸ì§€ UI */}
  </div>
)
```

#### ì—ëŸ¬ í† ìŠ¤íŠ¸

```typescript
// VideoChat.tsx

const { error } = useVideoChat()

useEffect(() => {
  if (error) {
    toast.error(error)  // react-toastify ë“± ì‚¬ìš©
  }
}, [error])
```

#### ì—°ê²° ìƒíƒœ í‘œì‹œ

```typescript
// RemoteVideo ì»´í¬ë„ŒíŠ¸

const [connectionState, setConnectionState] = useState<RTCPeerConnectionState>('new')

useEffect(() => {
  const pc = peerConnections.current.get(userId)
  if (!pc) return

  const handleStateChange = () => {
    setConnectionState(pc.connectionState)
  }

  pc.addEventListener('connectionstatechange', handleStateChange)

  return () => {
    pc.removeEventListener('connectionstatechange', handleStateChange)
  }
}, [userId])

return (
  <div>
    <video ref={videoRef} autoPlay />

    {/* ì—°ê²° ìƒíƒœ ë°°ì§€ */}
    {connectionState === 'connecting' && <Badge>ì—°ê²° ì¤‘...</Badge>}
    {connectionState === 'failed' && <Badge color="red">ì—°ê²° ì‹¤íŒ¨</Badge>}
  </div>
)
```

---

### 6.5 DataChannel ì¶”ê°€ (ì±„íŒ…)

**ìš”êµ¬ì‚¬í•­:** ë¹„ë””ì˜¤ì™€ í•¨ê»˜ í…ìŠ¤íŠ¸ ì±„íŒ…

```typescript
// useWebRTC.ts ìˆ˜ì •

const createDataChannel = (pc: RTCPeerConnection, userId: string) => {
  const dataChannel = pc.createDataChannel('chat')

  dataChannel.onopen = () => {
    console.log(`ğŸ’¬ DataChannel ì—´ë¦¼: ${userId}`)
  }

  dataChannel.onmessage = (event) => {
    console.log(`ğŸ’¬ ë©”ì‹œì§€ ìˆ˜ì‹  from ${userId}:`, event.data)
    // ì±„íŒ… ë©”ì‹œì§€ ìƒíƒœì— ì¶”ê°€
    setChatMessages(prev => [...prev, { from: userId, text: event.data }])
  }

  return dataChannel
}

// sendOffer í•¨ìˆ˜ ìˆ˜ì •
const sendOffer = async (targetUserId: string) => {
  const pc = new RTCPeerConnection(configuration)

  // DataChannel ìƒì„± (Offer ì¸¡ì—ì„œë§Œ)
  const dataChannel = createDataChannel(pc, targetUserId)
  dataChannels.current.set(targetUserId, dataChannel)

  // ... ë‚˜ë¨¸ì§€ ë¡œì§
}

// handleOffer í•¨ìˆ˜ ìˆ˜ì •
const handleOffer = async (data: OfferData) => {
  const pc = new RTCPeerConnection(configuration)

  // DataChannel ìˆ˜ì‹  (Answer ì¸¡)
  pc.ondatachannel = (event) => {
    const dataChannel = event.channel
    dataChannels.current.set(data.from, dataChannel)

    dataChannel.onmessage = (msgEvent) => {
      setChatMessages(prev => [...prev, { from: data.from, text: msgEvent.data }])
    }
  }

  // ... ë‚˜ë¨¸ì§€ ë¡œì§
}

// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
const sendChatMessage = (userId: string, message: string) => {
  const dataChannel = dataChannels.current.get(userId)
  if (dataChannel && dataChannel.readyState === 'open') {
    dataChannel.send(message)
  }
}
```

---

### 6.6 í™”ë©´ ê³µìœ 

```typescript
// useLocalStream.ts ìˆ˜ì •

const startScreenShare = async () => {
  try {
    const screenStream = await navigator.mediaDevices.getDisplayMedia({
      video: { cursor: 'always' },
      audio: false
    })

    // ê¸°ì¡´ ë¹„ë””ì˜¤ íŠ¸ë™ êµì²´
    const screenTrack = screenStream.getVideoTracks()[0]

    // ëª¨ë“  PeerConnectionì˜ sender ì°¾ì•„ì„œ êµì²´
    peerConnections.current.forEach((pc) => {
      const sender = pc.getSenders().find(s => s.track?.kind === 'video')
      if (sender) {
        sender.replaceTrack(screenTrack)
      }
    })

    // í™”ë©´ ê³µìœ  ì¢…ë£Œ ì‹œ ì›ë˜ ì¹´ë©”ë¼ë¡œ ë³µê·€
    screenTrack.onended = () => {
      const videoTrack = localStream?.getVideoTracks()[0]
      if (videoTrack) {
        peerConnections.current.forEach((pc) => {
          const sender = pc.getSenders().find(s => s.track?.kind === 'video')
          if (sender) {
            sender.replaceTrack(videoTrack)
          }
        })
      }
    }

    return screenStream
  } catch (err) {
    console.error('í™”ë©´ ê³µìœ  ì‹¤íŒ¨:', err)
    throw err
  }
}
```

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 7.1 ë¹„ë””ì˜¤ê°€ ì•ˆ ë³´ì—¬ìš”!

**ì²´í¬ë¦¬ìŠ¤íŠ¸:**

1. **ë¯¸ë””ì–´ ê¶Œí•œ í™•ì¸**
   ```javascript
   navigator.permissions.query({ name: 'camera' })
     .then(result => console.log(result.state))  // 'granted', 'denied', 'prompt'
   ```

2. **HTTPS í™•ì¸**
   - `getUserMedia()`ëŠ” localhost ë˜ëŠ” HTTPSì—ì„œë§Œ ë™ì‘
   - HTTPì—ì„œëŠ” ê¶Œí•œ ê±°ë¶€

3. **ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸**
   - `NotAllowedError`: ê¶Œí•œ ê±°ë¶€
   - `NotFoundError`: ì¥ì¹˜ ì—†ìŒ
   - `NotReadableError`: ì´ë¯¸ ì‚¬ìš© ì¤‘

4. **video íƒœê·¸ ì†ì„± í™•ì¸**
   ```typescript
   <video
     autoPlay   // âš ï¸ í•„ìˆ˜!
     playsInline  // iOSìš©
     muted  // ë¡œì»¬ ë¹„ë””ì˜¤ëŠ” ìŒì†Œê±°
   />
   ```

---

### 7.2 Offer/Answer êµí™˜ í›„ì—ë„ ì—°ê²° ì•ˆ ë¨

**ì›ì¸:** ICE Candidate êµí™˜ ì‹¤íŒ¨

**í•´ê²°:**

1. **STUN ì„œë²„ í™•ì¸**
   ```typescript
   const configuration = {
     iceServers: [
       { urls: 'stun:stun.l.google.com:19302' },
       { urls: 'stun:stun1.l.google.com:19302' }
     ]
   }
   ```

2. **NAT/ë°©í™”ë²½ ì´ìŠˆ â†’ TURN ì„œë²„ ì¶”ê°€**
   ```typescript
   const configuration = {
     iceServers: [
       { urls: 'stun:stun.l.google.com:19302' },
       {
         urls: 'turn:your-turn-server.com:3478',
         username: 'user',
         credential: 'pass'
       }
     ]
   }
   ```

3. **ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§**
   ```typescript
   pc.oniceconnectionstatechange = () => {
     console.log('ICE ì—°ê²° ìƒíƒœ:', pc.iceConnectionState)
     // new â†’ checking â†’ connected â†’ completed
     // ë˜ëŠ” failed
   }
   ```

---

### 7.3 ontrack ì´ë²¤íŠ¸ê°€ ì•ˆ ë°œìƒí•´ìš”

**ì›ì¸:**

1. **í•¸ë“¤ëŸ¬ ë“±ë¡ íƒ€ì´ë°**
   ```typescript
   // âŒ ì˜ëª»ëœ ìˆœì„œ
   await pc.setRemoteDescription(offer)
   pc.ontrack = (event) => { /* ë„ˆë¬´ ëŠ¦ìŒ! */ }

   // âœ… ì˜¬ë°”ë¥¸ ìˆœì„œ
   pc.ontrack = (event) => { /* ... */ }
   await pc.setRemoteDescription(offer)
   ```

2. **ìƒëŒ€ë°©ì´ íŠ¸ë™ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ**
   ```typescript
   // í™•ì¸: ìƒëŒ€ë°©ë„ addTrack() í˜¸ì¶œí–ˆëŠ”ì§€?
   localStream.getTracks().forEach(track => {
     pc.addTrack(track, localStream)
   })
   ```

---

### 7.4 ì–‘ë°©í–¥ Offerë¡œ ì¸í•œ ì¶©ëŒ

**ì¦ìƒ:** ë‘ ëª…ì´ ë™ì‹œì— Offer ì „ì†¡ â†’ ì—°ê²° ì‹¤íŒ¨

**í•´ê²°:** Glare í•´ê²° (Offer Collision)

```typescript
// ë‚®ì€ socket.idë¥¼ ê°€ì§„ ìª½ë§Œ offer ì „ì†¡
const shouldSendOffer = (myId: string, peerId: string) => {
  return myId < peerId
}

// useVideoChat.ts
useEffect(() => {
  if (newUser && localStream && socket.current) {
    if (shouldSendOffer(socket.current.id, newUser)) {
      sendOffer(newUser)
    }
  }
}, [newUser, localStream, socket])
```

**ì£¼ì˜:** í˜„ì¬ êµ¬í˜„ì€ ì–‘ë°©í–¥ Offerë¥¼ í—ˆìš©í•˜ë©°, ëŒ€ë¶€ë¶„ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤. ë¬¸ì œ ë°œìƒ ì‹œì—ë§Œ ìœ„ ë¡œì§ ì ìš©.

---

### 7.5 ë©”ëª¨ë¦¬ ëˆ„ìˆ˜

**ì¦ìƒ:** ì¥ì‹œê°„ ì‚¬ìš© ì‹œ ë¸Œë¼ìš°ì € ëŠë ¤ì§

**ì›ì¸:**
- PeerConnection ë¯¸ì •ë¦¬
- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¯¸ì œê±°
- MediaStream ë¯¸í•´ì œ

**í•´ê²°:**

```typescript
// useWebRTC cleanup
useEffect(() => {
  return () => {
    // PeerConnection ì¢…ë£Œ
    peerConnections.current.forEach(pc => {
      pc.close()
    })
    peerConnections.current.clear()

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    socket.current?.off('offer', handleOffer)
    // ...
  }
}, [])

// useLocalStream cleanup
useEffect(() => {
  return () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop())
    }
  }
}, [])
```

---

## 8. ì„±ëŠ¥ ìµœì í™”

### 8.1 í•´ìƒë„ ì¡°ì ˆ

```typescript
// ë„¤íŠ¸ì›Œí¬ í’ˆì§ˆì— ë”°ë¼ ë™ì  ì¡°ì ˆ
const adjustResolution = (quality: 'high' | 'medium' | 'low') => {
  const constraints = {
    high: { width: 1280, height: 720 },
    medium: { width: 640, height: 480 },
    low: { width: 320, height: 240 }
  }[quality]

  localStream.getVideoTracks().forEach(track => {
    track.applyConstraints({ ...constraints })
  })
}
```

---

### 8.2 SFU/MCU ì „í™˜ ê³ ë ¤

**Mesh Topologyì˜ í•œê³„:**
- Nëª… ì°¸ì—¬ ì‹œ ê°ì N-1ê°œì˜ ì—…ë¡œë“œ í•„ìš”
- 4ëª… ì´ìƒë¶€í„° ëŒ€ì—­í­ ë¶€ì¡±

**í•´ê²°:** SFU(Selective Forwarding Unit) ì„œë²„ ì‚¬ìš©
- ì˜ˆ: Mediasoup, Janus, Jitsi
- í´ë¼ì´ì–¸íŠ¸ëŠ” 1ê°œì˜ ì—…ë¡œë“œë§Œ (ì„œë²„ê°€ ì¬ì „ì†¡)

---

## 9. ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ
- [MDN WebRTC API](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API)
- [Socket.IO ê³µì‹ ë¬¸ì„œ](https://socket.io/docs/v4/)

### ì˜ˆì œ ì½”ë“œ
- [WebRTC Samples](https://webrtc.github.io/samples/)
- [Simple Peer](https://github.com/feross/simple-peer)

### ì˜ìƒ ìë£Œ
- [WebRTC Crash Course](https://www.youtube.com/results?search_query=webrtc+crash+course)

---

## 10. ìš”ì•½

### í•µì‹¬ ê°œë… ì •ë¦¬

| ê°œë… | ì„¤ëª… | ì—­í•  |
|------|------|------|
| **WebRTC** | P2P ì‹¤ì‹œê°„ ë¯¸ë””ì–´ ì „ì†¡ | ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ |
| **Socket.IO** | ì–‘ë°©í–¥ í†µì‹  | Offer/Answer/ICE ì¤‘ê³„ (ì‹œê·¸ë„ë§) |
| **RTCPeerConnection** | P2P ì—°ê²° ê°ì²´ | ê° ì°¸ì—¬ìë§ˆë‹¤ 1ê°œì”© ìƒì„± |
| **Offer/Answer** | SDP êµí™˜ | ë¯¸ë””ì–´ ìŠ¤í™ í˜‘ìƒ |
| **ICE Candidate** | ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ | NAT í†µê³¼, ìµœì  ê²½ë¡œ ì„ íƒ |
| **STUN/TURN** | NAT í†µê³¼ ì„œë²„ | ê³µì¸ IP ë°œê²¬, ì¤‘ê³„ |

### ë°ì´í„° íë¦„

```
1. Socket.IOë¡œ ë°© ì…ì¥ â†’ existingUsers íšë“
2. ê° ì°¸ì—¬ìì—ê²Œ Offer ì „ì†¡ (Socket.IO ì¤‘ê³„)
3. Answer ìˆ˜ì‹  (Socket.IO ì¤‘ê³„)
4. ICE Candidate êµí™˜ (Socket.IO ì¤‘ê³„)
5. P2P ì—°ê²° ì™„ë£Œ â†’ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì§ì ‘ ì „ì†¡ (WebRTC)
```

### êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ë°±ì—”ë“œ: Socket.IO ì‹œê·¸ë„ë§ ì„œë²„
- [x] í”„ë¡ íŠ¸: useSocket (ì‹±ê¸€í†¤)
- [x] í”„ë¡ íŠ¸: useLocalStream (ë¯¸ë””ì–´ ì œì–´)
- [x] í”„ë¡ íŠ¸: useWebRTC (P2P ê´€ë¦¬)
- [x] í”„ë¡ íŠ¸: useRoom (ë°© ê´€ë¦¬)
- [x] í”„ë¡ íŠ¸: useVideoChat (í†µí•©)
- [x] í”„ë¡ íŠ¸: VideoChat UI
- [ ] ë¦¬ë‹¤ì´ë ‰ì…˜ ì²˜ë¦¬
- [ ] ì—ëŸ¬ ì²˜ë¦¬
- [ ] í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ê´€ë¦¬
- [ ] ì‚¬ìš©ìë³„ ìŒí–¥ ì œì–´
- [ ] DataChannel (ì±„íŒ…)
- [ ] í™”ë©´ ê³µìœ 

---

**ì´ ë¬¸ì„œëŠ” WebRTC í™”ìƒì±„íŒ…ì˜ ì™„ë²½í•œ êµ¬í˜„ ê°€ì´ë“œì…ë‹ˆë‹¤.**
ê° ì„¹ì…˜ì€ ë…ë¦½ì ìœ¼ë¡œ ì°¸ê³  ê°€ëŠ¥í•˜ë©°, í™•ì¥ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ í•´ë‹¹ í¬ì¸íŠ¸ë¥¼ ì°¾ì•„ ì ìš©í•˜ì„¸ìš”.

**Happy Coding! ğŸš€**
